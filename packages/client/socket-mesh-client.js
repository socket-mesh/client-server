async function e({socket:e,options:t}){"string"==typeof t.channel&&e.channels.kickOut(t.channel,t.message)}async function t({socket:e,options:t}){e.channels.write(t.channel,t.data)}async function s({transport:e}){await e.changeToUnauthenticatedState()}async function n({transport:e,options:t}){await e.setAuthorization(t)}class i{constructor(e){this._isBatching=!1,this.batchInterval=e?.batchInterval||50,this.batchOnHandshakeDuration=e?.batchOnHandshakeDuration??!1,this._batchingIntervalId=null,this._handshakeTimeoutId=null}cancelBatching(){null!==this._batchingIntervalId&&clearInterval(this._batchingIntervalId),this._isBatching=!1,this._batchingIntervalId=null}get isBatching(){return this._isBatching||null!==this._batchingIntervalId}onReady(){this._isBatching?this.start():"number"==typeof this.batchOnHandshakeDuration&&this.batchOnHandshakeDuration>0&&(this.start(),this._handshakeTimeoutId=setTimeout((()=>{this.stop()}),this.batchOnHandshakeDuration))}onDisconnected(){this.cancelBatching()}startBatching(){this._isBatching=!0,this.start()}start(){null===this._batchingIntervalId&&(this._batchingIntervalId=setInterval((()=>{this.flush()}),this.batchInterval))}stopBatching(){this._isBatching=!1,this.stop()}stop(){null!==this._batchingIntervalId&&clearInterval(this._batchingIntervalId),this._batchingIntervalId=null,null!==this._handshakeTimeoutId&&(clearTimeout(this._handshakeTimeoutId),this._handshakeTimeoutId=null),this.flush()}}class r extends i{constructor(e){super(e),this.type="requestBatching",this._requests=[],this._continue=null}cancelBatching(){super.cancelBatching(),this._requests=[],this._continue=null}flush(){this._requests.length&&(this._continue(this._requests),this._requests=[],this._continue=null)}sendRequest({requests:e,cont:t}){this.isBatching?(this._continue=t,this._requests.push(...e)):t(e)}}class o extends i{constructor(e){super(e),this.type="responseBatching",this._responses=[],this._continue=null}flush(){this._responses.length&&(this._continue(this._responses),this._responses=[],this._continue=null)}sendResponse({responses:e,cont:t}){this.isBatching?(this._continue=t,this._responses.push(...e)):t(e)}}class a{constructor(e,t,s,n){this.id=t,this._backpressure=0,this.currentNode=s,this.timeout=n,this.isAlive=!0,this.stream=e,this.stream.setConsumer(this.id,this)}clearActiveTimeout(e){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),delete this._timeoutId)}getStats(){const e={id:this.id,backpressure:this._backpressure};return null!=this.timeout&&(e.timeout=this.timeout),e}_resetBackpressure(){this._backpressure=0}applyBackpressure(e){this._backpressure++}releaseBackpressure(e){this._backpressure--}getBackpressure(){return this._backpressure}write(e){this.clearActiveTimeout(e),this.applyBackpressure(e),this._resolve&&(this._resolve(),delete this._resolve)}kill(e){this._killPacket={value:e,done:!0},void 0!==this._timeoutId&&this.clearActiveTimeout(this._killPacket),this._killPacket={value:e,done:!0},this._destroy(),this._resolve&&(this._resolve(),delete this._resolve)}_destroy(){this.isAlive=!1,this._resetBackpressure(),this.stream.removeConsumer(this.id)}async _waitForNextItem(e){return new Promise(((t,s)=>{let n;if(this._resolve=t,void 0!==e){let t=new Error("Stream consumer iteration timed out");(async()=>{let i=function(e){let t,s=new Promise((s=>{t=setTimeout(s,e)}));return{timeoutId:t,promise:s}}(e);n=i.timeoutId,await i.promise,t.name="TimeoutError",delete this._resolve,s(t)})()}this._timeoutId=n}))}[Symbol.asyncIterator](){return this}}class h extends a{constructor(e,t,s,n){super(e,t,s,n)}async next(){for(this.stream.setConsumer(this.id,this);;){if(!this.currentNode.next)try{await this._waitForNextItem(this.timeout)}catch(e){throw this._destroy(),e}if(this._killPacket){this._destroy();let e=this._killPacket;return delete this._killPacket,e}if(this.currentNode=this.currentNode.next,this.releaseBackpressure(this.currentNode.data),!this.currentNode.consumerId||this.currentNode.consumerId===this.id)return this.currentNode.data.done&&this._destroy(),this.currentNode.data}}return(){return this.currentNode=null,this._destroy(),{}}}class c{async next(e){let t=this.createConsumer(e),s=await t.next();return t.return(),s}async once(e){let t=await this.next(e);if(t.done){if(null!=e){const e=new Error("Stream consumer operation timed out early because stream ended");throw e.name="TimeoutError",e}await new Promise((()=>{}))}return t.value}[Symbol.asyncIterator](){return this.createConsumer()}}class u extends c{constructor(e){super(),e=e||{},this.nextConsumerId=1,this.generateConsumerId=e.generateConsumerId,this.generateConsumerId||(this.generateConsumerId=()=>this.nextConsumerId++),this.removeConsumerCallback=e.removeConsumerCallback,this._consumers=new Map,this.tailNode={next:null,data:{value:void 0,done:!1}}}_write(e,t){let s={data:e,next:null};t&&(s.consumerId=t),this.tailNode.next=s,this.tailNode=s;for(let e of this._consumers.values())e.write(s.data)}write(e){this._write({value:e,done:!1})}close(e){this._write({value:e,done:!0})}writeToConsumer(e,t){this._write({value:t,done:!1},e)}closeConsumer(e,t){this._write({value:t,done:!0},e)}kill(e){for(let t of this._consumers.keys())this.killConsumer(t,e)}killConsumer(e,t){let s=this._consumers.get(e);s&&s.kill(t)}getBackpressure(e){if(void 0===e){let e=0;for(let t of this._consumers.values()){let s=t.getBackpressure();s>e&&(e=s)}return e}let t=this._consumers.get(e);return t?t.getBackpressure():0}hasConsumer(e){return this._consumers.has(e)}setConsumer(e,t){this._consumers.set(e,t),t.currentNode||(t.currentNode=this.tailNode)}removeConsumer(e){let t=this._consumers.delete(e);return this.removeConsumerCallback&&this.removeConsumerCallback(e),t}getConsumerStats(e){if(void 0===e){let e=[];for(let t of this._consumers.values())e.push(t.getStats());return e}const t=this._consumers.get(e);if(t)return t.getStats()}createConsumer(e){return new h(this,this.generateConsumerId(),this.tailNode,e)}getConsumerList(){return[...this._consumers.values()]}getConsumerCount(){return this._consumers.size}}class l{constructor(){this._inboundMessageStream=new u,this.handleInboundMessageStream()}handleInboundMessageStream(){(async()=>{for await(let{message:e,callback:t,promise:s}of this._inboundMessageStream){t(null,e);try{await s}catch(e){}}})()}onEnd({transport:e}){"close"===e.streamCleanupMode?this._inboundMessageStream.close():"kill"===e.streamCleanupMode&&this._inboundMessageStream.kill()}onMessageRaw(e){let t;const s=new Promise(((e,s)=>{t=(t,n)=>{t?s(t):e(n)}}));return this._inboundMessageStream.write({callback:t,...e}),s}}const m=["#handshake","#removeAuthToken"];class d{constructor(){this.type="offline",this._isReady=!1,this._requests=[],this._continue=null}sendRequest({requests:e,cont:t}){if(this._isReady)return void t(e);const s=e.filter((e=>m.indexOf(String(e.method))>-1));let n=e;s.length&&(n=s.length===e.length?[]:e.filter((e=>m.indexOf(String(e.method))<0))),n.length&&(this._continue=t,this._requests.push(n)),s.length&&t(s)}onReady(){this._isReady=!0,this.flush()}onClose(){this._isReady=!1}onDisconnected(){this._requests=[],this._continue=null}flush(){if(this._requests.length){for(const e of this._requests)this._continue(e);this._requests=[],this._continue=null}}}function p(e){return"object"==typeof e&&"saveToken"in e&&"removeToken"in e&&"loadToken"in e}class g{constructor({authTokenName:e}={}){this._internalStorage={},this.isLocalStorageEnabled=this._checkLocalStorageEnabled(),this._authTokenName=e??"socketmesh.authToken"}_checkLocalStorageEnabled(){let e;try{localStorage.setItem("__localStorageTest","1"),localStorage.removeItem("__localStorageTest")}catch(t){e=t}return!e}async saveToken(e){return this.isLocalStorageEnabled?localStorage.setItem(this._authTokenName,e):this._internalStorage[this._authTokenName]=e,e}async removeToken(){let e=this.loadToken();return this.isLocalStorageEnabled?localStorage.removeItem(this._authTokenName):delete this._internalStorage[this._authTokenName],e}async loadToken(){let e;return e=this.isLocalStorageEnabled?localStorage.getItem(this._authTokenName):this._internalStorage[this._authTokenName]||null,e}}class _{constructor(e,t){this._name=e,this._listeners=t}getConsumerStats(e){return"number"==typeof e?this.hasConsumer(e)?this._listeners.getConsumerStats(e):void 0:this._listeners.getConsumerStats(this._name,e)}getBackpressure(e){return"number"==typeof e?this.hasConsumer(e)?this._listeners.getBackpressure(e):0:this._listeners.getBackpressure(this._name,e)}hasConsumer(e,t){return"string"==typeof e?this._listeners.hasConsumer(this._name,e,t):this._listeners.hasConsumer(this._name,e)}close(e){this._listeners.close(this._name,e)}kill(e){"number"!=typeof e?this._listeners.kill(this._name,e):this.hasConsumer(e)&&this._listeners.kill(e)}}class b{constructor(e,t){this._name=e,this._output=t}hasConsumer(e){return this._output.hasConsumer(this._name,e)}getBackpressure(e){return"number"==typeof e?this.hasConsumer(e)?this._output.getBackpressure(e):0:this._output.getBackpressure(this._name)}getConsumerStats(e){return"number"==typeof e?this.hasConsumer(e)?this._output.getConsumerStats(e):void 0:this._output.getConsumerStats(this._name)}close(){this._output.close(this._name)}kill(e){"number"!=typeof e?this._output.kill(this._name):this.hasConsumer(e)&&this._output.kill(e)}}class k extends c{constructor(e,t,s,n){super(),this.name=e,this.channels=t,this.listeners=new _(e,t.listeners),this.output=new b(e,t.output),this._eventDemux=s,this._dataStream=n.listen(this.name)}emit(e,t){this._eventDemux.write(`${this.name}/${e}`,t)}listen(e){return this._eventDemux.listen(`${this.name}/${e}`)}createConsumer(e){return this._dataStream.createConsumer(e)}close(){this.channels.close(this.name)}closeEvent(e){this._eventDemux.close(`${this.name}/${e}`)}getBackpressure(){return this.channels.getBackpressure(this.name)}kill(){this.channels.kill(this.name)}killEvent(e){this._eventDemux.kill(`${this.name}/${e}`)}get state(){return this.channels.getState(this.name)}get options(){return this.channels.getOptions(this.name)}subscribe(e){this.channels.subscribe(this.name,e)}unsubscribe(){this.channels.unsubscribe(this.name)}isSubscribed(e){return this.channels.isSubscribed(this.name,e)}transmitPublish(e){return this.channels.transmitPublish(this.name,e)}invokePublish(e){return this.channels.invokePublish(this.name,e)}}class f extends c{constructor(e,t){super(),this._streamDemux=e,this.name=t}createConsumer(e){return this._streamDemux.createConsumer(this.name,e)}}class S{constructor(){this.streams={},this._nextConsumerId=1,this.generateConsumerId=()=>this._nextConsumerId++}write(e,t){this.streams[e]&&this.streams[e].write(t),this._allEventsStream&&this._allEventsStream.write({stream:e,value:t})}close(e="",t){if("number"!=typeof e)e?(this._allEventsStream&&this._allEventsStream.write({stream:e,value:t}),this.streams[e]&&this.streams[e].close(t)):this._allEventsStream.close();else for(let s of Object.values(this.streams))if(s.hasConsumer(e))return s.closeConsumer(e,t)}closeAll(e){for(let[t,s]of Object.entries(this.streams))this._allEventsStream&&this._allEventsStream.write({stream:t,value:e}),s.close(e);this._allEventsStream&&this._allEventsStream.close()}writeToConsumer(e,t){for(let s of Object.values(this.streams))if(s.hasConsumer(e))return s.writeToConsumer(e,t)}getConsumerStats(e){if(void 0===e){const e=[];this._allEventsStream&&e.push(...this.getConsumerStats(""));for(let t of Object.keys(this.streams))e.push(...this.getConsumerStats(t));return e}if(""===e)return this._allEventsStream?this._allEventsStream.getConsumerStats().map((t=>({...t,stream:e}))):[];if("string"==typeof e)return this.streams[e]?this.streams[e].getConsumerStats().map((t=>({...t,stream:e}))):[];if(this._allEventsStream&&this._allEventsStream.hasConsumer(e))return{stream:"",...this._allEventsStream.getConsumerStats(e)};for(let[t,s]of Object.entries(this.streams))if(s.hasConsumer(e))return{stream:t,...s.getConsumerStats(e)}}kill(e="",t){if("number"!=typeof e)e&&this.streams[e]&&(this._allEventsStream&&this._allEventsStream.write({stream:e,value:t}),this.streams[e].kill(t)),!e&&this._allEventsStream&&this._allEventsStream.kill();else for(let s of Object.values(this.streams))if(s.hasConsumer(e))return s.killConsumer(e,t)}killAll(e){for(let[t,s]of Object.entries(this.streams))this._allEventsStream&&this._allEventsStream.write({stream:t,value:e}),s.kill(e);this._allEventsStream&&this._allEventsStream.kill()}getBackpressure(e){if("string"==typeof e)return e?this.streams[e]?this.streams[e].getBackpressure():0:this._allEventsStream?.getBackpressure()??0;if("number"==typeof e){if(this._allEventsStream&&this._allEventsStream.hasConsumer(e))return this._allEventsStream.getBackpressure(e);for(let t of Object.values(this.streams))if(t.hasConsumer(e))return t.getBackpressure(e);return 0}return Object.values(this.streams).reduce(((e,t)=>Math.max(e,t.getBackpressure())),this._allEventsStream?.getBackpressure()??0)}hasConsumer(e,t){return"number"==typeof e?this._allEventsStream?.hasConsumer(e)||Object.values(this.streams).some((t=>t.hasConsumer(e))):e&&this.streams[e]?this.streams[e].hasConsumer(t):!(e||!this._allEventsStream)&&this._allEventsStream.hasConsumer(t)}getConsumerCount(e){return!e&&this._allEventsStream?this._allEventsStream.getConsumerCount():e&&this.streams[e]?this.streams[e].getConsumerCount():0}createConsumer(e,t){return e?"number"==typeof e&&(t=e,e=""):e="",e?(this.streams[e]||(this.streams[e]=new u({generateConsumerId:this.generateConsumerId,removeConsumerCallback:()=>{this.getConsumerCount(e)||delete this.streams[e]}})),this.streams[e].createConsumer(t)):(this._allEventsStream||(this._allEventsStream=new u({generateConsumerId:this.generateConsumerId,removeConsumerCallback:()=>{this.getConsumerCount("")||(this._allEventsStream=null)}})),this._allEventsStream.createConsumer(t))}listen(e=""){return new f(this,e)}unlisten(e=""){e?delete this.streams[e]:this._allEventsStream=null}}class v{constructor(e){this._streamDemux=e}listen(e){return this._streamDemux.listen(e)}close(e){void 0===e&&this._streamDemux.closeAll(),this._streamDemux.close(e)}kill(e){void 0!==e?this._streamDemux.kill(e):this._streamDemux.killAll()}getConsumerStats(e){return this._streamDemux.getConsumerStats(e)}getBackpressure(e){return this._streamDemux.getBackpressure(e)}hasConsumer(e,t){return"string"==typeof e?this._streamDemux.hasConsumer(e,t):this._streamDemux.hasConsumer(e)}}class C{constructor(e){this._eventDemux=e}getConsumerStats(e,t){return void 0===e?this._eventDemux.getConsumerStats():"number"==typeof e?this._eventDemux.getConsumerStats(e):"string"==typeof t?this._eventDemux.getConsumerStats(`${e}/${t}`):this.getAllStreamNames(e).map((e=>this._eventDemux.getConsumerStats(e))).reduce(((e,t)=>(t.forEach((t=>{e.push(t)})),e)),[])}getBackpressure(e,t){if(void 0===e)return this._eventDemux.getBackpressure();if("number"==typeof e)return this._eventDemux.getBackpressure(e);if("string"==typeof t)return this._eventDemux.getBackpressure(`${e}/${t}`);let s=this.getAllStreamNames(e).map((e=>this._eventDemux.getBackpressure(e)));return Math.max(...s.concat(0))}close(e,t){void 0!==e?"string"!=typeof t?this.getAllStreamNames(e).forEach((e=>{this._eventDemux.close(e)})):this._eventDemux.close(`${e}/${t}`):this._eventDemux.closeAll()}kill(e,t){void 0!==e?"number"!=typeof e?t?this._eventDemux.kill(`${e}/${t}`):this.getAllStreamNames(e).forEach((e=>{this._eventDemux.kill(e)})):this._eventDemux.kill(e):this._eventDemux.killAll()}hasConsumer(e,t,s){return"string"==typeof t?this._eventDemux.hasConsumer(`${e}/${t}`,s):this.getAllStreamNames(e).some((e=>this._eventDemux.hasConsumer(e,t)))}getAllStreamNames(e){const t=this._eventDemux.getConsumerStats().filter((t=>0===t.stream.indexOf(`${e}/`))).reduce(((e,t)=>(e[t.stream]=!0,e)),{});return Object.keys(t)}}class w{constructor(){this._listenerDemux=new S}static from(e){const t=new w,s=e.emit.bind(e),n=t.emit.bind(t);if(e.emit=(e,...t)=>{const i=s.call(null,e,...t);return n.call(null,e,t),i},e.on&&e.on("error",(()=>{})),e.listenerCount){const s=e.listenerCount.bind(e);e.listenerCount=(e,n)=>s(e,n)+t.getListenerConsumerCount(e)}return t}emit(e,t){this._listenerDemux.write(e,t)}listen(e){return this._listenerDemux.listen(e)}closeListeners(e){void 0!==e?this._listenerDemux.close(e):this._listenerDemux.closeAll()}getListenerConsumerStats(e){return this._listenerDemux.getConsumerStats(e)}getListenerConsumerCount(e){return this._listenerDemux.getConsumerCount(e)}killListeners(e){void 0!==e?this._listenerDemux.kill(e):this._listenerDemux.killAll()}getListenerBackpressure(e){return this._listenerDemux.getBackpressure(e)}removeListener(e){this._listenerDemux.unlisten(e)}hasListenerConsumer(e,t){return this._listenerDemux.hasConsumer(e,t)}}class T extends w{constructor(e){super(),e||(e={}),this.channelPrefix=e.channelPrefix,this._channelMap={},this._channelEventDemux=new S,this.listeners=new C(this._channelEventDemux),this._channelDataDemux=new S,this.output=new v(this._channelDataDemux)}cancelPendingSubscribeCallback(e){e.subscribeAbort&&e.subscribeAbort()}channel(e){return this._channelMap[e],new k(e,this,this._channelEventDemux,this._channelDataDemux)}close(e){this.output.close(e),this.listeners.close(e)}decorateChannelName(e){return`${this.channelPrefix||""}${e}`}kill(e){this.output.kill(e),this.listeners.kill(e)}getBackpressure(e){return Math.max(this.output.getBackpressure(e),this.listeners.getBackpressure(e))}getState(e){const t=this._channelMap[e];return t?t.state:"unsubscribed"}getOptions(e){const t=this._channelMap[e];return t?{...t.options}:{}}kickOut(e,t){const s=this.undecorateChannelName(e),n=this._channelMap[s];n&&(this.emit("kickOut",{channel:s,message:t}),this._channelEventDemux.write(`${s}/kickOut`,{channel:s,message:t}),this.triggerChannelUnsubscribe(n))}subscribe(e,t){t=t||{};let s=this._channelMap[e];const n={waitForAuth:!!t.waitForAuth};null!=t.priority&&(n.priority=t.priority),void 0!==t.data&&(n.data=t.data),s?t&&(s.options=n):(s={name:e,state:"pending",options:n},this._channelMap[e]=s,this.trySubscribe(s));return new k(e,this,this._channelEventDemux,this._channelDataDemux)}triggerChannelSubscribe(e,t){const s=e.name;if("subscribed"!==e.state){const n=e.state;e.state="subscribed";const i={channel:s,oldState:n,newState:e.state,options:t};this._channelEventDemux.write(`${s}/subscribeStateChange`,i),this._channelEventDemux.write(`${s}/subscribe`,{channel:e.name,options:t}),this.emit("subscribeStateChange",i),this.emit("subscribe",{channel:s,options:t})}}triggerChannelUnsubscribe(e,t){const s=e.name;if(this.cancelPendingSubscribeCallback(e),"subscribed"===e.state){const n={channel:e.name,oldState:e.state,newState:t?"pending":"unsubscribed",options:e.options};this._channelEventDemux.write(`${s}/subscribeStateChange`,n),this._channelEventDemux.write(`${s}/unsubscribe`,{channel:e.name}),this.emit("subscribeStateChange",n),this.emit("unsubscribe",{channel:s})}t?e.state="pending":delete this._channelMap[s]}undecorateChannelName(e){return this.channelPrefix&&0===e.indexOf(this.channelPrefix)?e.replace(this.channelPrefix,""):e}unsubscribe(e){const t=this._channelMap[e];t&&this.tryUnsubscribe(t)}subscriptions(e){const t=[];return Object.keys(this._channelMap).forEach((s=>{(e||"subscribed"===this._channelMap[s].state)&&t.push(s)})),t}isSubscribed(e,t){const s=this._channelMap[e];return t?!!s:!!s&&"subscribed"===s.state}emit(e,t){super.emit(e,t)}listen(e){return super.listen(e)}write(e,t){const s=this.undecorateChannelName(e);this.isSubscribed(s,!0)&&this._channelDataDemux.write(s,t)}}class y extends T{constructor(e,t){t||(t={}),super(t),this.autoSubscribeOnConnect=t.autoSubscribeOnConnect??!0,this._transport=e,this._preparingPendingSubscriptions=!1,this._transport.plugins.push({type:"channels",onAuthenticated:()=>{this._preparingPendingSubscriptions||this.processPendingSubscriptions()},onReady:()=>{this.autoSubscribeOnConnect&&this.processPendingSubscriptions()},onClose:()=>{this.suspendSubscriptions()}})}suspendSubscriptions(){for(const e in this._channelMap)this.triggerChannelUnsubscribe(this._channelMap[e],!0)}trySubscribe(e){const t=!e.options.waitForAuth||!!this._transport.signedAuthToken;if("ready"===this._transport.status&&!this._preparingPendingSubscriptions&&!e.subscribePromise&&t){const t={};e.options.waitForAuth&&(t.waitForAuth=!0),e.options.data&&(t.data=e.options.data),[e.subscribePromise,e.subscribeAbort]=this._transport.invoke({method:"#subscribe",ackTimeoutMs:!1},{channel:this.decorateChannelName(e.name),...t}),e.subscribePromise.then((()=>{delete e.subscribePromise,delete e.subscribeAbort,this.triggerChannelSubscribe(e,t)})).catch((s=>{"BadConnectionError"!==s.name&&("AbortError"!==s.name&&this.triggerChannelSubscribeFail(s,e,t),delete e.subscribePromise,delete e.subscribeAbort)})),this.emit("subscribeRequest",{channel:e.name,options:t})}}processPendingSubscriptions(){this._preparingPendingSubscriptions=!1;const e=[];Object.keys(this._channelMap).forEach((t=>{const s=this._channelMap[t];"pending"===s.state&&e.push(s)})),e.sort(((e,t)=>{const s=e.options.priority||0,n=t.options.priority||0;return s>n?-1:s<n?1:0})),e.forEach((e=>{this.trySubscribe(e)}))}unsubscribe(e){const t=this._channelMap[e];t&&this.tryUnsubscribe(t)}tryUnsubscribe(e){if(this.triggerChannelUnsubscribe(e),"ready"===this._transport.status){this.cancelPendingSubscribeCallback(e);const t=this.decorateChannelName(e.name);this._transport.transmit("#unsubscribe",t).catch((e=>{}))}}triggerChannelSubscribeFail(e,t,s){const n=!t.options.waitForAuth||!!this._transport.signedAuthToken;!!this._channelMap[t.name]&&n&&(delete this._channelMap[t.name],this._channelEventDemux.write(`${t.name}/subscribeFail`,{channel:t.name,error:e,options:s}),this.emit("subscribeFail",{error:e,channel:t.name,options:s}))}transmitPublish(e,t){const s={channel:this.decorateChannelName(e),data:t};return this._transport.transmit("#publish",s)}invokePublish(e,t){const s={channel:this.decorateChannelName(e),data:t};return this._transport.invoke("#publish",s)[0]}}function E(e){return"object"==typeof e&&"method"in e}function M(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}function x(e,t){e.sentCallback&&e.sentCallback(t),"callback"in e&&e.callback&&e.callback(t)}function A(e){return"callback"in e?null===e.callback:!e.sentCallback}class D extends Error{constructor(e){super(e),this.name="AbortError",Object.setPrototypeOf(this,D.prototype)}}class I extends Error{constructor(e,t){super(e),this.name="PluginBlockedError",this.type=t,Object.setPrototypeOf(this,I.prototype)}}class R extends Error{constructor(e){super(e),this.name="InvalidActionError",Object.setPrototypeOf(this,R.prototype)}}class P extends Error{constructor(e){super(e),this.name="InvalidArgumentsError",Object.setPrototypeOf(this,P.prototype)}}class O extends Error{constructor(e,t){super(e),this.name="SocketProtocolError",this.code=t,Object.setPrototypeOf(this,O.prototype)}}class B extends Error{constructor(e){super(e),this.name="TimeoutError",Object.setPrototypeOf(this,B.prototype)}}class N extends Error{constructor(e,t){super(e),this.name="BadConnectionError",this.type=t,Object.setPrototypeOf(this,N.prototype)}}const j={1001:"Socket was disconnected",1002:"A WebSocket protocol error was encountered",1003:"Server terminated socket because it received invalid data",1005:"Socket closed without status code",1006:"Socket hung up",1007:"Message format was incorrect",1008:"Encountered a policy violation",1009:"Message was too big to process",1010:"Client ended the connection because the server did not comply with extension requirements",1011:"Server encountered an unexpected fatal condition",4e3:"Server ping timed out",4001:"Client pong timed out",4002:"Server failed to sign auth token",4003:"Failed to complete handshake",4004:"Client failed to save auth token",4005:"Did not receive #handshake from client before timeout",4006:"Failed to bind socket to message broker",4007:"Client connection establishment timed out",4008:"Server rejected handshake from client",4009:"Server received a message before the client handshake"},$={1e3:"Socket closed normally",1001:"Socket hung up"};function q(e){let t;if(e&&"object"==typeof e){t={message:e.message};for(let s of Object.keys(e))t[s]=e[s]}else t="function"==typeof e?"[function "+("string"==typeof e.name?e.name:"anonymous")+"]":e;return s=[],n=[],function e(t,i){var r,o,a;if(!("object"!=typeof t||null===t||t instanceof Boolean||t instanceof Date||t instanceof Number||t instanceof RegExp||t instanceof String)){for(r=0;r<s.length;r+=1)if(s[r]===t)return{$ref:n[r]};if(s.push(t),n.push(i),"[object Array]"===Object.prototype.toString.apply(t))for(a=[],r=0;r<t.length;r+=1)a[r]=e(t[r],i+"["+r+"]");else for(o in a={},t)Object.prototype.hasOwnProperty.call(t,o)&&(a[o]=e(t[o],i+"["+JSON.stringify(o)+"]"));return a}return t}(t,"$");var s,n}function U(e){let t=null;if(null!=e)if("object"==typeof e){t=new Error("string"==typeof e.message?e.message:"Invalid error message format"),"string"==typeof e.name&&(t.name=e.name);for(let s of Object.keys(e))void 0===t[s]&&(t[s]=e[s])}else t=e;return t}class L{constructor(e){this.isRpc=e.isRpc,this.method=e.method,this.options=e.options,this.requestedAt=new Date,this.socket=e.socket,this.transport=e.transport,this.timeoutMs=e.timeoutMs}checkTimeout(e=0){if("number"==typeof this.timeoutMs&&this.getRemainingTimeMs()<=e)throw new B(`Method '${this.method}' timed out.`)}getRemainingTimeMs(){return"number"==typeof this.timeoutMs?this.requestedAt.valueOf()+this.timeoutMs-(new Date).valueOf():1/0}}function F(e){return"object"==typeof e&&"rid"in e}class z extends w{constructor(e,t){super(),this.state=t?.state||{},e.socket=this,this._transport=e}get id(){return this._transport.id}get authToken(){return this._transport.authToken}get signedAuthToken(){return this._transport.signedAuthToken}deauthenticate(){return this._transport.changeToUnauthenticatedState()}disconnect(e=1e3,t){this._transport.disconnect(e,t)}getBackpressure(){return Math.max(this._transport.getBackpressure(),this.getListenerBackpressure())}getInboundBackpressure(){return this._transport.getInboundBackpressure()}getOutboundBackpressure(){return this._transport.getOutboundBackpressure()}emit(e,t){super.emit(e,t)}listen(e){return super.listen(e)}ping(){return this._transport.ping()}get status(){return this._transport.status}get url(){return this._transport.url}transmit(e,t){return this._transport.transmit(e,t)}invoke(e,t){return this._transport.invoke(e,t)[0]}}const W="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",H=/^[ \n\r\t]*[{\[]/;function G(e){const t=new Uint8Array(e),s=t.length;let n="";for(let e=0;e<s;e+=3)n+=W[t[e]>>2],n+=W[(3&t[e])<<4|t[e+1]>>4],n+=W[(15&t[e+1])<<2|t[e+2]>>6],n+=W[63&t[e+2]];return s%3==2?n=n.substring(0,n.length-1)+"=":s%3==1&&(n=n.substring(0,n.length-2)+"=="),n}function J(e,t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer)return{base64:!0,data:G(t)};if("undefined"!=typeof Buffer){if(t instanceof Buffer)return{base64:!0,data:t.toString("base64")};if(t&&"Buffer"===t.type&&Array.isArray(t.data)){let e;return e=Buffer.from?Buffer.from(t.data):new Buffer(t.data),{base64:!0,data:e.toString("base64")}}}return t}const K=new class{decode(e){if(null==e)return null;if("#1"===e||"#2"===e)return e;const t=e.toString();if(!H.test(t))return t;try{return JSON.parse(t)}catch(e){}return t}encode(e){return"#1"===e||"#2"===e?e:JSON.stringify(e,J)}};var Q=null;"undefined"!=typeof WebSocket?Q=WebSocket:"undefined"!=typeof MozWebSocket?Q=MozWebSocket:"undefined"!=typeof global?Q=global.WebSocket||global.MozWebSocket:"undefined"!=typeof window?Q=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(Q=self.WebSocket||self.MozWebSocket);var V,X=Q;!function(e){e.AUTHENTICATED="authenticated",e.UNAUTHENTICATED="unauthenticated"}(V||(V={}));class Y{constructor(e){let t=1;this.ackTimeoutMs=e?.ackTimeoutMs??1e4,this._callIdGenerator=e?.callIdGenerator||(()=>t++),this._callbackMap={},this.codecEngine=e?.codecEngine||K,this._handlers=e?.handlers||{},this.id=null,this._inboundProcessedMessageCount=0,this._inboundReceivedMessageCount=0,this._outboundPreparedMessageCount=0,this._outboundSentMessageCount=0,this._pingTimeoutRef=null,this.plugins=e?.plugins||[],this.streamCleanupMode=e?.streamCleanupMode||"kill"}abortAllPendingCallbacksDueToBadConnection(e){for(const t in this._callbackMap){const s=this._callbackMap[t],n=`Event ${s.method} was aborted due to a bad connection`;s.callback(new N(n,"ready"===e?"disconnect":"connectAbort"))}}get authToken(){return this._authToken}async changeToUnauthenticatedState(){if(this._signedAuthToken){const e=this._authToken,t=this._signedAuthToken;this._authToken=null,this._signedAuthToken=null,this._socket.emit("authStateChange",{wasAuthenticated:!0,isAuthenticated:!1}),await M(0),this._socket.emit("deauthenticate",{signedAuthToken:t,authToken:e});for(const e of this.plugins)e.onDeauthenticate&&e.onDeauthenticate({socket:this.socket,transport:this});return!0}return!1}decode(e){try{return this.codecEngine.decode(e)}catch(e){return"Error"===e.name&&(e.name="InvalidMessageError"),this.onError(e),null}}disconnect(e=1e3,t){this.webSocket&&(this.webSocket.close(e,t),this.onClose(e,t))}getBackpressure(){return Math.max(this.getInboundBackpressure(),this.getOutboundBackpressure())}getInboundBackpressure(){return this._inboundReceivedMessageCount-this._inboundProcessedMessageCount}getOutboundBackpressure(){return this._outboundPreparedMessageCount-this._outboundSentMessageCount}async handleInboudMessage({data:e,timestamp:t}){let s=this.decode(e);if(null!==s){var n;n=s,s=Array.isArray(n)?n:[n];for(let e of s){let s;try{for(const s of this.plugins)s.onMessage&&(e=await s.onMessage({socket:this.socket,transport:this,packet:e,timestamp:t}))}catch(e){s=e}F(e)?this.onResponse(e,s):E(e)&&await this.onRequest(e,t,s)}}}onClose(e,t){const s=this.status;this.webSocket=null,this._isReady=!1,clearTimeout(this._pingTimeoutRef),this._pingTimeoutRef=null,this.abortAllPendingCallbacksDueToBadConnection(s);for(const e of this.plugins)e.onClose&&e.onClose({socket:this.socket,transport:this});if(!$[e]){let s;s="string"==typeof t?`Socket connection closed with status code ${e} and reason: ${t}`:`Socket connection closed with status code ${e}`,this.onError(new O(j[e]||s,e))}const n=t?.toString()||j[e];this._socket.emit("close",{code:e,reason:n})}onDisconnect(e,t,s){"ready"===e?this._socket.emit("disconnect",{code:t,reason:s}):this._socket.emit("connectAbort",{code:t,reason:s});for(const n of this.plugins)n.onDisconnected&&n.onDisconnected({socket:this.socket,transport:this,status:e,code:t,reason:s})}onError(e){this._socket.emit("error",{error:e})}onInvoke(e){this.sendRequest([e])}onMessage(e,t){const s=new Date;let n,i,r=Promise.resolve(t?e:e.toString());const o=new Promise(((e,t)=>{n=e,i=t}));this._inboundReceivedMessageCount++;for(let e=0;e<this.plugins.length;e++){const t=this.plugins[e];t.onMessageRaw&&(r=r.then((e=>t.onMessageRaw({socket:this.socket,transport:this,message:e,timestamp:s,promise:o}))))}r.then((e=>(this._socket.emit("message",{data:e,isBinary:t}),this.handleInboudMessage({data:e,timestamp:s})))).then(n).catch((e=>{i(e),e instanceof I||this.onError(e)})).finally((()=>{this._inboundProcessedMessageCount++}))}onOpen(){for(const e of this.plugins)e.onOpen&&e.onOpen({socket:this.socket,transport:this})}onPing(e){this._socket.emit("ping",{data:e})}onPong(e){this._socket.emit("pong",{data:e})}async onRequest(e,t,s){this._socket.emit("request",{request:e});const n="number"==typeof e.ackTimeoutMs?new Date(t.valueOf()+e.ackTimeoutMs):null;let i,r,o=!1;if(s)o=!0,r=s,i={rid:e.cid,timeoutAt:n,error:s};else{const t=this._handlers[e.method];if(t){o=!0;try{const s=await t(new L({isRpc:!!e.cid,method:e.method.toString(),timeoutMs:e.ackTimeoutMs,socket:this._socket,transport:this,options:e.data}));e.cid&&(i={rid:e.cid,timeoutAt:n,data:s})}catch(t){r=t,e.cid&&(i={rid:e.cid,timeoutAt:n,error:r})}}}return i&&this.sendResponse([i]),r&&this.onError(r),o||(o=this.onUnhandledRequest(e)),o}onResponse(e,t){const s=this._callbackMap[e.rid];s&&(s.timeoutId&&(clearTimeout(s.timeoutId),delete s.timeoutId),t?s.callback(t):"error"in e?s.callback(U(e.error)):s.callback(null,"data"in e?e.data:void 0)),t?this._socket.emit("response",{response:{rid:e.rid,error:t}}):this._socket.emit("response",{response:e})}onTransmit(e){this.sendRequest([e])}onUnexpectedResponse(e,t){this._socket.emit("unexpectedResponse",{request:e,response:t})}onUnhandledRequest(e){return!!this._onUnhandledRequest&&this._onUnhandledRequest(this,e)}onUpgrade(e){this._socket.emit("upgrade",{request:e})}ping(){return new Promise(((e,t)=>{this.webSocket.ping(void 0,void 0,(s=>{s?t(s):e()}))}))}resetPingTimeout(e,t){this._pingTimeoutRef&&(clearTimeout(this._pingTimeoutRef),this._pingTimeoutRef=null),!1!==e&&(this._pingTimeoutRef=setTimeout((()=>{this.webSocket.close(t)}),e))}send(e){return new Promise(((t,s)=>{try{this._webSocket.send(e,(e=>{e?s(e):t()}))}catch(e){throw e}}))}sendRequest(e,t){if("object"==typeof e&&(t=e,e=0),t.some((e=>A(e)))&&!(t=t.filter((e=>A(e)))).length)return;for(;e<this.plugins.length;e++){const s=this.plugins[e];if("sendRequest"in s){e++;try{s.sendRequest({socket:this.socket,transport:this,requests:t,cont:this.sendRequest.bind(this,e)})}catch(e){for(const s of t)x(s,e)}return}}if("closed"===this.status){for(const e of t){const t=new N(`Socket ${"callback"in e?"invoke":"transmit"} ${String(e.method)} event was aborted due to a bad connection`,"connectAbort");this.onError(t),x(e,t)}return}const s=t.map((e=>{if("callback"in e){const{callback:t,promise:s,timeoutId:n,...i}=e;return this._callbackMap[e.cid]={method:["service"in e?e.service:"",e.method].filter(Boolean).join("."),timeoutId:e.timeoutId,callback:e.callback},i}const{promise:t,...s}=e;return s}));this._webSocket.send(this.codecEngine.encode(1===s.length?s[0]:s),(e=>{for(const s of t)"ECONNRESET"===e?.code&&(e=new N(`Socket ${"callback"in s?"invoke":"transmit"} ${String(s.method)} event was aborted due to a bad connection`,"connectAbort")),s.sentCallback&&s.sentCallback(e),e&&"callback"in s&&s.callback(e)}))}sendResponse(e,t){if("object"==typeof e&&(t=e,e=0),(t=t.filter((e=>!e.timeoutAt||e.timeoutAt>new Date))).length){for(;e<this.plugins.length;e++){const s=this.plugins[e];if("sendResponse"in s){e++;try{s.sendResponse({socket:this.socket,transport:this,responses:t,cont:this.sendResponse.bind(this,e)})}catch(s){this.sendResponse(e,t.map((e=>({rid:e.rid,timeoutAt:e.timeoutAt,error:s}))))}return}}if("closed"!==this.status){for(const e of t)"error"in e&&(e.error=q(e.error)),delete e.timeoutAt;this._webSocket.send(this.codecEngine.encode(1===t.length?t[0]:t),(e=>{e&&this.onError(e)}))}else for(const e of t)this.onError(new Error("WebSocket is not open: readyState 3 (CLOSED)"))}}async setAuthorization(e,t){if("string"!=typeof e)throw new P("SignedAuthToken must be type string.");if(e!==this._signedAuthToken){if(!t){const s=function(e){if("string"!=typeof e)return null;let t=e.split(".")[1];if(null!=t){let e=t;try{return e=Buffer.from(e,"base64").toString("utf8"),JSON.parse(e)}catch(t){return e}}return null}(e);if("string"==typeof s)throw new P("Invalid authToken.");t=s}return this._authToken=t,this._signedAuthToken=e,!0}return!1}setReadyStatus(e,t){if(this._webSocket?.readyState!==X.OPEN)throw new R("Cannot set status to OPEN before socket is connected.");this._isReady=!0;for(const e of this.plugins)e.onReady&&e.onReady({socket:this.socket,transport:this});this._socket.emit("connect",{id:this.id,pingTimeoutMs:e,isAuthenticated:!!this.signedAuthToken,authError:t})}get signedAuthToken(){return this._signedAuthToken}get socket(){return this._socket}set socket(e){this._socket=e}get status(){if(!this._webSocket)return"closed";if(this._isReady)return"ready";switch(this._webSocket.readyState){case X.CONNECTING:case X.OPEN:return"connecting";case X.CLOSING:return"closing";default:return"closed"}}triggerAuthenticationEvents(e,t){this._socket.emit("authStateChange",{wasAuthenticated:t,isAuthenticated:!0,authToken:this._authToken,signedAuthToken:this._signedAuthToken}),this._socket.emit("authenticate",{wasSigned:e,signedAuthToken:this._signedAuthToken,authToken:this._authToken});for(const e of this.plugins)e.onAuthenticated&&e.onAuthenticated({socket:this.socket,transport:this})}transmit(e,t){let s,n,i;Array.isArray(e)?(s=e[0],n=e[1]):i=e;const r=s?{service:s,method:n,promise:null,data:t}:{data:t,method:i,promise:null},o=r.promise=new Promise(((e,t)=>{r.sentCallback=s=>{delete r.sentCallback,this._outboundSentMessageCount++,s?t(s):e()}}));return this._outboundPreparedMessageCount++,this.onTransmit(r),o}invoke(e,t){let s,n,i,r;"object"==typeof e?Array.isArray(e)?(s=e[0],n=e[1],r=e[2]):("service"in e?(s=e.service,n=e.method):i=e.method,r=e.ackTimeoutMs):i=e;let o=this._callbackMap;const a=Object.assign({cid:this._callIdGenerator(),ackTimeoutMs:r??this.ackTimeoutMs,callback:null,promise:null},s?{service:s,method:n,data:t}:{method:i,data:t});let h;const c=a.promise=new Promise(((e,t)=>{a.ackTimeoutMs&&(a.timeoutId=setTimeout((()=>{delete o[a.cid],a.callback=null,clearTimeout(a.timeoutId),delete a.timeoutId,t(new B(`Method '${[s,a.method].filter(Boolean).join(".")}' timed out.`))}),a.ackTimeoutMs)),h=()=>{delete o[a.cid],a.timeoutId&&(clearTimeout(a.timeoutId),delete a.timeoutId),a.callback&&(a.callback=null,t(new D(`Method '${[s,a.method].filter(Boolean).join(".")}' was aborted.`)))},a.callback=(s,n)=>{delete o[a.cid],a.callback=null,a.timeoutId&&(clearTimeout(a.timeoutId),delete a.timeoutId),s?t(s):e(n)},a.sentCallback=()=>{delete a.sentCallback,this._outboundSentMessageCount++}}));return this._outboundPreparedMessageCount++,this.onInvoke(a),[c,h]}get url(){return this._webSocket.url}get webSocket(){return this._webSocket}set webSocket(e){this._webSocket&&(this._webSocket.off("open",this.onOpen),this._webSocket.off("close",this.onClose),this._webSocket.off("error",this.onError),this._webSocket.off("upgrade",this.onUpgrade),this._webSocket.off("message",this.onMessage),this._webSocket.off("ping",this.onPing),this._webSocket.off("pong",this.onPong),this._webSocket.off("unexpectedResponse",this.onUnexpectedResponse),delete this.onOpen,delete this.onClose,delete this.onError,delete this.onUpgrade,delete this.onMessage,delete this.onPing,delete this.onPong,delete this.onUnexpectedResponse),this._webSocket=e,e&&(this._webSocket.on("open",this.onOpen=this.onOpen.bind(this)),this._webSocket.on("close",this.onClose=this.onClose.bind(this)),this._webSocket.on("error",this.onError=this.onError.bind(this)),this._webSocket.on("upgrade",this.onUpgrade=this.onUpgrade.bind(this)),this._webSocket.on("message",this.onMessage=this.onMessage.bind(this)),this._webSocket.on("ping",this.onPing=this.onPing.bind(this)),this._webSocket.on("pong",this.onPong=this.onPong.bind(this)),this._webSocket.on("unexpectedResponse",this.onUnexpectedResponse=this.onUnexpectedResponse.bind(this)))}}class Z extends Y{constructor(e){super(e),this.type="client",this._uri="string"==typeof e.address?new URL(e.address):e.address,this.authEngine=p(e.authEngine)?e.authEngine:new g(Object.assign({authTokenName:`socketmesh.authToken${this._uri.protocol}${this._uri.hostname}`},e.authEngine)),this.connectTimeoutMs=e.connectTimeoutMs??2e4,this._pingTimeoutMs=this.connectTimeoutMs,e.wsOptions&&(this._wsOptions=e.wsOptions),this._connectAttempts=0,this._pendingReconnectTimeout=null,this.autoReconnect=e.autoReconnect,this.isPingTimeoutDisabled=!0===e.isPingTimeoutDisabled}get autoReconnect(){return this._autoReconnect}set autoReconnect(e){this._autoReconnect=!!e&&Object.assign({initialDelay:1e4,randomness:1e4,multiplier:1.5,maxDelayMs:6e4},!0===e?{}:e)}connect(e){let t=this.connectTimeoutMs;if(e){let s=!1;e.connectTimeoutMs&&(t=e.connectTimeoutMs),e.address&&(s=!0,this._uri="string"==typeof e.address?new URL(e.address):e.address),e.wsOptions&&(s=!0,this._wsOptions=e.wsOptions),s&&"closed"!==this.status&&this.disconnect(1e3,"Socket was disconnected by the client to initiate a new connection")}"closed"===this.status&&(this.webSocket=new X(this._uri,this._wsOptions),this.socket.emit("connecting",{}),this._connectTimeoutRef=setTimeout((()=>{this.disconnect(4007)}),t))}get connectAttempts(){return this._connectAttempts}decode(e){return super.decode(e)}disconnect(e=1e3,t){4007!==e&&this.resetReconnect(),super.disconnect(e,t)}async handshake(){const e=await this.authEngine.loadToken(),t=await this.invoke("#handshake",{authToken:e})[0];return"authError"in t&&(t.authError=U(t.authError)),t}onOpen(){let e;super.onOpen(),clearTimeout(this._connectTimeoutRef),this._connectTimeoutRef=null,this.resetReconnect(),this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3),this.handshake().then((t=>(this.id=t.id,this.pingTimeoutMs=t.pingTimeoutMs,"authToken"in t&&t.authToken?this.setAuthorization(t.authToken):("authError"in t&&(e=t.authError),this.changeToUnauthenticatedState())))).then((()=>{this.setReadyStatus(this.pingTimeoutMs,e)})).catch((e=>{null==e.statusCode&&(e.statusCode=4003),this.onError(e),this.disconnect(e.statusCode,e.toString())}))}onPing(e){this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3),super.onPing(e)}onClose(e,t){const s=this.status;let n=!1;if(super.onClose(e,t),this.autoReconnect&&(4e3===e||4001===e||1005===e?(n=!!this.autoReconnect,this.tryReconnect(0)):1e3!==e&&e<4500&&(n=!!this.autoReconnect,this.tryReconnect())),!n){const n=t?.toString()||j[e];this.onDisconnect(s,e,n)}}get pendingReconnect(){return null!==this._pendingReconnectTimeout}get pingTimeoutMs(){return this._pingTimeoutMs}set pingTimeoutMs(e){this._pingTimeoutMs=e,this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3)}resetReconnect(){this._pendingReconnectTimeout=null,this._connectAttempts=0}async setAuthorization(e,t){const s=!!this.signedAuthToken,n=await super.setAuthorization(e,t);return n&&(this.triggerAuthenticationEvents(!1,s),this.authEngine.saveToken(this.signedAuthToken).catch((e=>{this.onError(e)}))),n}get status(){return this.pendingReconnect?"connecting":super.status}tryReconnect(e){if(!this.autoReconnect)return;const t=this._connectAttempts++,s=this.autoReconnect;let n;if(null==e||t>0){const e=Math.round(s.initialDelay+(s.randomness||0)*Math.random());n=Math.round(e*Math.pow(s.multiplier,t))}else n=e;n>s.maxDelayMs&&(n=s.maxDelayMs),this._pendingReconnectTimeout=n,this.connect({connectTimeoutMs:n})}get uri(){return this._uri}get webSocket(){return super.webSocket}set webSocket(e){if(this.webSocket&&this._connectTimeoutRef&&(clearTimeout(this._connectTimeoutRef),this._connectTimeoutRef=null),super.webSocket=e,this.webSocket){function t(){this.off("open",t),this.off("close",t),this.off("error",t)}this.webSocket.on("open",t),this.webSocket.on("close",t),this.webSocket.on("error",t)}}async transmit(e,t){"closed"===this.status&&(this.connect(),await this.socket.listen("connect").once()),await super.transmit(e,t)}invoke(e,t){let s;return[Promise.resolve().then((()=>{if("closed"===this.status)return this.connect(),this.socket.listen("connect").once()})).then((()=>{const n=super.invoke(e,t);return s=n[1],n[0]})),s]}}function ee(e){return("string"==typeof e||"pathname"in e)&&(e={address:e}),Object.assign({},e)}class te extends z{constructor(i){(i=ee(i)).handlers=Object.assign({"#kickOut":e,"#publish":t,"#setAuthToken":n,"#removeAuthToken":s},i.handlers);const r=new Z(i);super(r,i),this._clientTransport=r,this.channels=new y(this._clientTransport,i),!1!==i.autoConnect&&this.connect(i)}async authenticate(e){try{await this._clientTransport.invoke("#authenticate",e)[0],this._clientTransport.setAuthorization(e),await M(0)}catch(e){throw"BadConnectionError"!==e.name&&"TimeoutError"!==e.name&&(await this._clientTransport.changeToUnauthenticatedState(),await M(0)),U(e)}}get autoReconnect(){return this._clientTransport.autoReconnect}set autoReconnect(e){this._clientTransport.autoReconnect=e}connect(e){this._clientTransport.connect(e)}get connectTimeoutMs(){return this._clientTransport.connectTimeoutMs}set connectTimeoutMs(e){this._clientTransport.connectTimeoutMs=e}async deauthenticate(){return(async()=>{let e;try{e=await this._clientTransport.authEngine.removeToken()}catch(e){return void this._clientTransport.onError(e)}this.emit("removeAuthToken",{oldAuthToken:e})})(),"closed"!==this.status&&await this._clientTransport.transmit("#removeAuthToken"),await super.deauthenticate()}get isPingTimeoutDisabled(){return this._clientTransport.isPingTimeoutDisabled}set isPingTimeoutDisabled(e){this._clientTransport.isPingTimeoutDisabled=e}get pingTimeoutMs(){return this._clientTransport.pingTimeoutMs}set pingTimeoutMs(e){this._clientTransport.pingTimeoutMs=e}reconnect(e,t){this.disconnect(e,t),this.connect()}get type(){return this._clientTransport.type}get uri(){return this._clientTransport.uri}}export{i as BatchingPlugin,y as ClientChannels,te as ClientSocket,Z as ClientTransport,l as InOrderPlugin,g as LocalStorageAuthEngine,d as OfflinePlugin,r as RequestBatchingPlugin,o as ResponseBatchingPlugin,p as isAuthEngine,e as kickOutHandler,ee as parseClientOptions,t as publishHandler,s as removeAuthTokenHandler,n as setAuthTokenHandler};
