async function t({socket:t,options:e}){"string"==typeof e.channel&&t.channels.kickOut(e.channel,e.message)}async function e({socket:t,options:e}){t.channels.write(e.channel,e.data)}async function s({transport:t}){await t.changeToUnauthenticatedState()}async function n({transport:t,options:e}){await t.setAuthorization(e)}class i{constructor(t){this._isBatching=!1,this.batchInterval=t?.batchInterval||50,this.batchOnHandshakeDuration=t?.batchOnHandshakeDuration??!1,this._batchingIntervalId=null,this._handshakeTimeoutId=null}cancelBatching(){null!==this._batchingIntervalId&&clearInterval(this._batchingIntervalId),this._isBatching=!1,this._batchingIntervalId=null}get isBatching(){return this._isBatching||null!==this._batchingIntervalId}onReady(){this._isBatching?this.start():"number"==typeof this.batchOnHandshakeDuration&&this.batchOnHandshakeDuration>0&&(this.start(),this._handshakeTimeoutId=setTimeout((()=>{this.stop()}),this.batchOnHandshakeDuration))}onDisconnected(){this.cancelBatching()}startBatching(){this._isBatching=!0,this.start()}start(){null===this._batchingIntervalId&&(this._batchingIntervalId=setInterval((()=>{this.flush()}),this.batchInterval))}stopBatching(){this._isBatching=!1,this.stop()}stop(){null!==this._batchingIntervalId&&clearInterval(this._batchingIntervalId),this._batchingIntervalId=null,null!==this._handshakeTimeoutId&&(clearTimeout(this._handshakeTimeoutId),this._handshakeTimeoutId=null),this.flush()}}class r extends i{constructor(t){super(t),this.type="requestBatching",this._requests=[],this._continue=null}cancelBatching(){super.cancelBatching(),this._requests=[],this._continue=null}flush(){this._requests.length&&(this._continue(this._requests),this._requests=[],this._continue=null)}sendRequest({requests:t,cont:e}){this.isBatching?(this._continue=e,this._requests.push(...t)):e(t)}}class o extends i{constructor(t){super(t),this.type="responseBatching",this._responses=[],this._continue=null}flush(){this._responses.length&&(this._continue(this._responses),this._responses=[],this._continue=null)}sendResponse({responses:t,cont:e}){this.isBatching?(this._continue=e,this._responses.push(...t)):e(t)}}class a{constructor(t,e,s,n){this.id=e,this._backpressure=0,this.currentNode=s,this.timeout=n,this.isAlive=!0,this.stream=t,this.stream.setConsumer(this.id,this)}clearActiveTimeout(t){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),delete this._timeoutId)}getStats(){const t={id:this.id,backpressure:this._backpressure};return null!=this.timeout&&(t.timeout=this.timeout),t}_resetBackpressure(){this._backpressure=0}applyBackpressure(t){this._backpressure++}releaseBackpressure(t){this._backpressure--}getBackpressure(){return this._backpressure}write(t){this.clearActiveTimeout(t),this.applyBackpressure(t),this._resolve&&(this._resolve(),delete this._resolve)}kill(t){this._killPacket={value:t,done:!0},void 0!==this._timeoutId&&this.clearActiveTimeout(this._killPacket),this._killPacket={value:t,done:!0},this._destroy(),this._resolve&&(this._resolve(),delete this._resolve)}_destroy(){this.isAlive=!1,this._resetBackpressure(),this.stream.removeConsumer(this.id)}async _waitForNextItem(t){return new Promise(((e,s)=>{let n;if(this._resolve=e,void 0!==t){let e=new Error("Stream consumer iteration timed out");(async()=>{let i=function(t){let e,s=new Promise((s=>{e=setTimeout(s,t)}));return{timeoutId:e,promise:s}}(t);n=i.timeoutId,await i.promise,e.name="TimeoutError",delete this._resolve,s(e)})()}this._timeoutId=n}))}[Symbol.asyncIterator](){return this}}class h extends a{constructor(t,e,s,n){super(t,e,s,n)}async next(){for(this.stream.setConsumer(this.id,this);;){if(!this.currentNode.next)try{await this._waitForNextItem(this.timeout)}catch(t){throw this._destroy(),t}if(this._killPacket){this._destroy();let t=this._killPacket;return delete this._killPacket,t}if(this.currentNode=this.currentNode.next,this.releaseBackpressure(this.currentNode.data),!this.currentNode.consumerId||this.currentNode.consumerId===this.id)return this.currentNode.data.done&&this._destroy(),this.currentNode.data}}return(){return this.currentNode=null,this._destroy(),{}}}class c{async next(t){let e=this.createConsumer(t),s=await e.next();return e.return(),s}async once(t){let e=await this.next(t);if(e.done){if(null!=t){const t=new Error("Stream consumer operation timed out early because stream ended");throw t.name="TimeoutError",t}await new Promise((()=>{}))}return e.value}[Symbol.asyncIterator](){return this.createConsumer()}}class u extends c{constructor(t){super(),t=t||{},this.nextConsumerId=1,this.generateConsumerId=t.generateConsumerId,this.generateConsumerId||(this.generateConsumerId=()=>this.nextConsumerId++),this.removeConsumerCallback=t.removeConsumerCallback,this._consumers=new Map,this.tailNode={next:null,data:{value:void 0,done:!1}}}_write(t,e){let s={data:t,next:null};e&&(s.consumerId=e),this.tailNode.next=s,this.tailNode=s;for(let t of this._consumers.values())t.write(s.data)}write(t){this._write({value:t,done:!1})}close(t){this._write({value:t,done:!0})}writeToConsumer(t,e){this._write({value:e,done:!1},t)}closeConsumer(t,e){this._write({value:e,done:!0},t)}kill(t){for(let e of this._consumers.keys())this.killConsumer(e,t)}killConsumer(t,e){let s=this._consumers.get(t);s&&s.kill(e)}getBackpressure(t){if(void 0===t){let t=0;for(let e of this._consumers.values()){let s=e.getBackpressure();s>t&&(t=s)}return t}let e=this._consumers.get(t);return e?e.getBackpressure():0}hasConsumer(t){return this._consumers.has(t)}setConsumer(t,e){this._consumers.set(t,e),e.currentNode||(e.currentNode=this.tailNode)}removeConsumer(t){let e=this._consumers.delete(t);return this.removeConsumerCallback&&this.removeConsumerCallback(t),e}getConsumerStats(t){if(void 0===t){let t=[];for(let e of this._consumers.values())t.push(e.getStats());return t}const e=this._consumers.get(t);if(e)return e.getStats()}createConsumer(t){return new h(this,this.generateConsumerId(),this.tailNode,t)}getConsumerList(){return[...this._consumers.values()]}getConsumerCount(){return this._consumers.size}}class l{constructor(){this._inboundMessageStream=new u,this.handleInboundMessageStream()}handleInboundMessageStream(){(async()=>{for await(let{message:t,callback:e,promise:s}of this._inboundMessageStream){e(null,t);try{await s}catch(t){}}})()}onEnd({transport:t}){"close"===t.streamCleanupMode?this._inboundMessageStream.close():"kill"===t.streamCleanupMode&&this._inboundMessageStream.kill()}onMessageRaw(t){let e;const s=new Promise(((t,s)=>{e=(e,n)=>{e?s(e):t(n)}}));return this._inboundMessageStream.write({callback:e,...t}),s}}const m=["#handshake","#removeAuthToken"];class d{constructor(){this.type="offline",this._isReady=!1,this._requests=[],this._continue=null}sendRequest({requests:t,cont:e}){if(this._isReady)return void e(t);const s=t.filter((t=>m.indexOf(String(t.method))>-1));let n=t;s.length&&(n=s.length===t.length?[]:t.filter((t=>m.indexOf(String(t.method))<0))),n.length&&(this._continue=e,this._requests.push(n)),s.length&&e(s)}onReady(){this._isReady=!0,this.flush()}onClose(){this._isReady=!1}onDisconnected(){this._requests=[],this._continue=null}flush(){if(this._requests.length){for(const t of this._requests)this._continue(t);this._requests=[],this._continue=null}}}function p(t){return"object"==typeof t&&"saveToken"in t&&"removeToken"in t&&"loadToken"in t}class g{constructor({authTokenName:t}={}){this._internalStorage={},this.isLocalStorageEnabled=this._checkLocalStorageEnabled(),this._authTokenName=t??"socketmesh.authToken"}_checkLocalStorageEnabled(){let t;try{localStorage.setItem("__localStorageTest","1"),localStorage.removeItem("__localStorageTest")}catch(e){t=e}return!t}async saveToken(t){return this.isLocalStorageEnabled?localStorage.setItem(this._authTokenName,t):this._internalStorage[this._authTokenName]=t,t}async removeToken(){let t=this.loadToken();return this.isLocalStorageEnabled?localStorage.removeItem(this._authTokenName):delete this._internalStorage[this._authTokenName],t}async loadToken(){let t;return t=this.isLocalStorageEnabled?localStorage.getItem(this._authTokenName):this._internalStorage[this._authTokenName]||null,t}}class _{constructor(t,e){this._name=t,this._listeners=e}getConsumerStats(t){return"number"==typeof t?this.hasConsumer(t)?this._listeners.getConsumerStats(t):void 0:this._listeners.getConsumerStats(this._name,t)}getBackpressure(t){return"number"==typeof t?this.hasConsumer(t)?this._listeners.getBackpressure(t):0:this._listeners.getBackpressure(this._name,t)}hasConsumer(t,e){return"string"==typeof t?this._listeners.hasConsumer(this._name,t,e):this._listeners.hasConsumer(this._name,t)}close(t){this._listeners.close(this._name,t)}kill(t){"number"!=typeof t?this._listeners.kill(this._name,t):this.hasConsumer(t)&&this._listeners.kill(t)}}class b{constructor(t,e){this._name=t,this._output=e}hasConsumer(t){return this._output.hasConsumer(this._name,t)}getBackpressure(t){return"number"==typeof t?this.hasConsumer(t)?this._output.getBackpressure(t):0:this._output.getBackpressure(this._name)}getConsumerStats(t){return"number"==typeof t?this.hasConsumer(t)?this._output.getConsumerStats(t):void 0:this._output.getConsumerStats(this._name)}close(){this._output.close(this._name)}kill(t){"number"!=typeof t?this._output.kill(this._name):this.hasConsumer(t)&&this._output.kill(t)}}class k extends c{constructor(t,e,s,n){super(),this.name=t,this.channels=e,this.listeners=new _(t,e.listeners),this.output=new b(t,e.output),this._eventDemux=s,this._dataStream=n.listen(this.name)}emit(t,e){this._eventDemux.write(`${this.name}/${t}`,e)}listen(t){return this._eventDemux.listen(`${this.name}/${t}`)}createConsumer(t){return this._dataStream.createConsumer(t)}close(){this.channels.close(this.name)}closeEvent(t){this._eventDemux.close(`${this.name}/${t}`)}getBackpressure(){return this.channels.getBackpressure(this.name)}kill(){this.channels.kill(this.name)}killEvent(t){this._eventDemux.kill(`${this.name}/${t}`)}get state(){return this.channels.getState(this.name)}get options(){return this.channels.getOptions(this.name)}subscribe(t){this.channels.subscribe(this.name,t)}unsubscribe(){this.channels.unsubscribe(this.name)}isSubscribed(t){return this.channels.isSubscribed(this.name,t)}transmitPublish(t){return this.channels.transmitPublish(this.name,t)}invokePublish(t){return this.channels.invokePublish(this.name,t)}}class f extends c{constructor(t,e){super(),this._streamDemux=t,this.name=e}createConsumer(t){return this._streamDemux.createConsumer(this.name,t)}}class S{constructor(){this.streams={},this._nextConsumerId=1,this.generateConsumerId=()=>this._nextConsumerId++}write(t,e){this.streams[t]&&this.streams[t].write(e),this._allEventsStream&&this._allEventsStream.write({stream:t,value:e})}close(t="",e){if("number"!=typeof t)t?(this._allEventsStream&&this._allEventsStream.write({stream:t,value:e}),this.streams[t]&&this.streams[t].close(e)):this._allEventsStream.close();else for(let s of Object.values(this.streams))if(s.hasConsumer(t))return s.closeConsumer(t,e)}closeAll(t){for(let[e,s]of Object.entries(this.streams))this._allEventsStream&&this._allEventsStream.write({stream:e,value:t}),s.close(t);this._allEventsStream&&this._allEventsStream.close()}writeToConsumer(t,e){for(let s of Object.values(this.streams))if(s.hasConsumer(t))return s.writeToConsumer(t,e)}getConsumerStats(t){if(void 0===t){const t=[];this._allEventsStream&&t.push(...this.getConsumerStats(""));for(let e of Object.keys(this.streams))t.push(...this.getConsumerStats(e));return t}if(""===t)return this._allEventsStream?this._allEventsStream.getConsumerStats().map((e=>({...e,stream:t}))):[];if("string"==typeof t)return this.streams[t]?this.streams[t].getConsumerStats().map((e=>({...e,stream:t}))):[];if(this._allEventsStream&&this._allEventsStream.hasConsumer(t))return{stream:"",...this._allEventsStream.getConsumerStats(t)};for(let[e,s]of Object.entries(this.streams))if(s.hasConsumer(t))return{stream:e,...s.getConsumerStats(t)}}kill(t="",e){if("number"!=typeof t)t&&this.streams[t]&&(this._allEventsStream&&this._allEventsStream.write({stream:t,value:e}),this.streams[t].kill(e)),!t&&this._allEventsStream&&this._allEventsStream.kill();else for(let s of Object.values(this.streams))if(s.hasConsumer(t))return s.killConsumer(t,e)}killAll(t){for(let[e,s]of Object.entries(this.streams))this._allEventsStream&&this._allEventsStream.write({stream:e,value:t}),s.kill(t);this._allEventsStream&&this._allEventsStream.kill()}getBackpressure(t){if("string"==typeof t)return t?this.streams[t]?this.streams[t].getBackpressure():0:this._allEventsStream?.getBackpressure()??0;if("number"==typeof t){if(this._allEventsStream&&this._allEventsStream.hasConsumer(t))return this._allEventsStream.getBackpressure(t);for(let e of Object.values(this.streams))if(e.hasConsumer(t))return e.getBackpressure(t);return 0}return Object.values(this.streams).reduce(((t,e)=>Math.max(t,e.getBackpressure())),this._allEventsStream?.getBackpressure()??0)}hasConsumer(t,e){return"number"==typeof t?this._allEventsStream?.hasConsumer(t)||Object.values(this.streams).some((e=>e.hasConsumer(t))):t&&this.streams[t]?this.streams[t].hasConsumer(e):!(t||!this._allEventsStream)&&this._allEventsStream.hasConsumer(e)}getConsumerCount(t){return!t&&this._allEventsStream?this._allEventsStream.getConsumerCount():t&&this.streams[t]?this.streams[t].getConsumerCount():0}createConsumer(t,e){return t?"number"==typeof t&&(e=t,t=""):t="",t?(this.streams[t]||(this.streams[t]=new u({generateConsumerId:this.generateConsumerId,removeConsumerCallback:()=>{this.getConsumerCount(t)||delete this.streams[t]}})),this.streams[t].createConsumer(e)):(this._allEventsStream||(this._allEventsStream=new u({generateConsumerId:this.generateConsumerId,removeConsumerCallback:()=>{this.getConsumerCount("")||(this._allEventsStream=null)}})),this._allEventsStream.createConsumer(e))}listen(t=""){return new f(this,t)}unlisten(t=""){t?delete this.streams[t]:this._allEventsStream=null}}class v{constructor(t){this._streamDemux=t}listen(t){return this._streamDemux.listen(t)}close(t){void 0===t&&this._streamDemux.closeAll(),this._streamDemux.close(t)}kill(t){void 0!==t?this._streamDemux.kill(t):this._streamDemux.killAll()}getConsumerStats(t){return this._streamDemux.getConsumerStats(t)}getBackpressure(t){return this._streamDemux.getBackpressure(t)}hasConsumer(t,e){return"string"==typeof t?this._streamDemux.hasConsumer(t,e):this._streamDemux.hasConsumer(t)}}class C{constructor(t){this._eventDemux=t}getConsumerStats(t,e){return void 0===t?this._eventDemux.getConsumerStats():"number"==typeof t?this._eventDemux.getConsumerStats(t):"string"==typeof e?this._eventDemux.getConsumerStats(`${t}/${e}`):this.getAllStreamNames(t).map((t=>this._eventDemux.getConsumerStats(t))).reduce(((t,e)=>(e.forEach((e=>{t.push(e)})),t)),[])}getBackpressure(t,e){if(void 0===t)return this._eventDemux.getBackpressure();if("number"==typeof t)return this._eventDemux.getBackpressure(t);if("string"==typeof e)return this._eventDemux.getBackpressure(`${t}/${e}`);let s=this.getAllStreamNames(t).map((t=>this._eventDemux.getBackpressure(t)));return Math.max(...s.concat(0))}close(t,e){void 0!==t?"string"!=typeof e?this.getAllStreamNames(t).forEach((t=>{this._eventDemux.close(t)})):this._eventDemux.close(`${t}/${e}`):this._eventDemux.closeAll()}kill(t,e){void 0!==t?"number"!=typeof t?e?this._eventDemux.kill(`${t}/${e}`):this.getAllStreamNames(t).forEach((t=>{this._eventDemux.kill(t)})):this._eventDemux.kill(t):this._eventDemux.killAll()}hasConsumer(t,e,s){return"string"==typeof e?this._eventDemux.hasConsumer(`${t}/${e}`,s):this.getAllStreamNames(t).some((t=>this._eventDemux.hasConsumer(t,e)))}getAllStreamNames(t){const e=this._eventDemux.getConsumerStats().filter((e=>0===e.stream.indexOf(`${t}/`))).reduce(((t,e)=>(t[e.stream]=!0,t)),{});return Object.keys(e)}}class T{constructor(){this._listenerDemux=new S}static from(t){const e=new T,s=t.emit.bind(t),n=e.emit.bind(e);if(t.emit=(t,...e)=>{const i=s.call(null,t,...e);return n.call(null,t,e),i},t.on&&t.on("error",(()=>{})),t.listenerCount){const s=t.listenerCount.bind(t);t.listenerCount=(t,n)=>s(t,n)+e.getListenerConsumerCount(t)}return e}emit(t,e){this._listenerDemux.write(t,e)}listen(t){return this._listenerDemux.listen(t)}closeListeners(t){void 0!==t?this._listenerDemux.close(t):this._listenerDemux.closeAll()}getListenerConsumerStats(t){return this._listenerDemux.getConsumerStats(t)}getListenerConsumerCount(t){return this._listenerDemux.getConsumerCount(t)}killListeners(t){void 0!==t?this._listenerDemux.kill(t):this._listenerDemux.killAll()}getListenerBackpressure(t){return this._listenerDemux.getBackpressure(t)}removeListener(t){this._listenerDemux.unlisten(t)}hasListenerConsumer(t,e){return this._listenerDemux.hasConsumer(t,e)}}class y extends T{constructor(t){super(),t||(t={}),this.channelPrefix=t.channelPrefix,this._channelMap={},this._channelEventDemux=new S,this.listeners=new C(this._channelEventDemux),this._channelDataDemux=new S,this.output=new v(this._channelDataDemux)}cancelPendingSubscribeCallback(t){t.subscribeAbort&&t.subscribeAbort()}channel(t){return this._channelMap[t],new k(t,this,this._channelEventDemux,this._channelDataDemux)}close(t){this.output.close(t),this.listeners.close(t)}decorateChannelName(t){return`${this.channelPrefix||""}${t}`}kill(t){this.output.kill(t),this.listeners.kill(t)}getBackpressure(t){return Math.max(this.output.getBackpressure(t),this.listeners.getBackpressure(t))}getState(t){const e=this._channelMap[t];return e?e.state:"unsubscribed"}getOptions(t){const e=this._channelMap[t];return e?{...e.options}:{}}kickOut(t,e){const s=this.undecorateChannelName(t),n=this._channelMap[s];n&&(this.emit("kickOut",{channel:s,message:e}),this._channelEventDemux.write(`${s}/kickOut`,{channel:s,message:e}),this.triggerChannelUnsubscribe(n))}subscribe(t,e){e=e||{};let s=this._channelMap[t];const n={waitForAuth:!!e.waitForAuth};null!=e.priority&&(n.priority=e.priority),void 0!==e.data&&(n.data=e.data),s?e&&(s.options=n):(s={name:t,state:"pending",options:n},this._channelMap[t]=s,this.trySubscribe(s));return new k(t,this,this._channelEventDemux,this._channelDataDemux)}triggerChannelSubscribe(t,e){const s=t.name;if("subscribed"!==t.state){const n=t.state;t.state="subscribed";const i={channel:s,oldState:n,newState:t.state,options:e};this._channelEventDemux.write(`${s}/subscribeStateChange`,i),this._channelEventDemux.write(`${s}/subscribe`,{channel:t.name,options:e}),this.emit("subscribeStateChange",i),this.emit("subscribe",{channel:s,options:e})}}triggerChannelUnsubscribe(t,e){const s=t.name;if(this.cancelPendingSubscribeCallback(t),"subscribed"===t.state){const n={channel:t.name,oldState:t.state,newState:e?"pending":"unsubscribed",options:t.options};this._channelEventDemux.write(`${s}/subscribeStateChange`,n),this._channelEventDemux.write(`${s}/unsubscribe`,{channel:t.name}),this.emit("subscribeStateChange",n),this.emit("unsubscribe",{channel:s})}e?t.state="pending":delete this._channelMap[s]}undecorateChannelName(t){return this.channelPrefix&&0===t.indexOf(this.channelPrefix)?t.replace(this.channelPrefix,""):t}unsubscribe(t){const e=this._channelMap[t];e&&this.tryUnsubscribe(e)}subscriptions(t){const e=[];return Object.keys(this._channelMap).forEach((s=>{(t||"subscribed"===this._channelMap[s].state)&&e.push(s)})),e}isSubscribed(t,e){const s=this._channelMap[t];return e?!!s:!!s&&"subscribed"===s.state}emit(t,e){super.emit(t,e)}listen(t){return super.listen(t)}write(t,e){const s=this.undecorateChannelName(t);this.isSubscribed(s,!0)&&this._channelDataDemux.write(s,e)}}class w extends y{constructor(t,e){e||(e={}),super(e),this.autoSubscribeOnConnect=e.autoSubscribeOnConnect??!0,this._transport=t,this._preparingPendingSubscriptions=!1,this._transport.plugins.push({type:"channels",onAuthenticated:()=>{this._preparingPendingSubscriptions||this.processPendingSubscriptions()},onReady:()=>{this.autoSubscribeOnConnect&&this.processPendingSubscriptions()},onClose:()=>{this.suspendSubscriptions()}})}suspendSubscriptions(){for(const t in this._channelMap)this.triggerChannelUnsubscribe(this._channelMap[t],!0)}trySubscribe(t){const e=!t.options.waitForAuth||!!this._transport.signedAuthToken;if("ready"===this._transport.status&&!this._preparingPendingSubscriptions&&!t.subscribePromise&&e){const e={};t.options.waitForAuth&&(e.waitForAuth=!0),t.options.data&&(e.data=t.options.data),[t.subscribePromise,t.subscribeAbort]=this._transport.invoke({method:"#subscribe",ackTimeoutMs:!1},{channel:this.decorateChannelName(t.name),...e}),t.subscribePromise.then((()=>{delete t.subscribePromise,delete t.subscribeAbort,this.triggerChannelSubscribe(t,e)})).catch((s=>{"BadConnectionError"!==s.name&&("AbortError"!==s.name&&this.triggerChannelSubscribeFail(s,t,e),delete t.subscribePromise,delete t.subscribeAbort)})),this.emit("subscribeRequest",{channel:t.name,options:e})}}processPendingSubscriptions(){this._preparingPendingSubscriptions=!1;const t=[];Object.keys(this._channelMap).forEach((e=>{const s=this._channelMap[e];"pending"===s.state&&t.push(s)})),t.sort(((t,e)=>{const s=t.options.priority||0,n=e.options.priority||0;return s>n?-1:s<n?1:0})),t.forEach((t=>{this.trySubscribe(t)}))}unsubscribe(t){const e=this._channelMap[t];e&&this.tryUnsubscribe(e)}tryUnsubscribe(t){if(this.triggerChannelUnsubscribe(t),"ready"===this._transport.status){this.cancelPendingSubscribeCallback(t);const e=this.decorateChannelName(t.name);this._transport.transmit("#unsubscribe",e).catch((t=>{}))}}triggerChannelSubscribeFail(t,e,s){const n=!e.options.waitForAuth||!!this._transport.signedAuthToken;!!this._channelMap[e.name]&&n&&(delete this._channelMap[e.name],this._channelEventDemux.write(`${e.name}/subscribeFail`,{channel:e.name,error:t,options:s}),this.emit("subscribeFail",{error:t,channel:e.name,options:s}))}transmitPublish(t,e){const s={channel:this.decorateChannelName(t),data:e};return this._transport.transmit("#publish",s)}invokePublish(t,e){const s={channel:this.decorateChannelName(t),data:e};return this._transport.invoke("#publish",s)[0]}}function E(t){return"object"==typeof t&&"method"in t}function M(t){return new Promise((e=>{setTimeout((()=>{e()}),t)}))}function x(t,e){t.sentCallback&&t.sentCallback(e),"callback"in t&&t.callback&&t.callback(e)}function A(t){return"callback"in t?null===t.callback:!t.sentCallback}class D extends Error{constructor(t){super(t),this.name="AbortError",Object.setPrototypeOf(this,D.prototype)}}class I extends Error{constructor(t,e){super(t),this.name="PluginBlockedError",this.type=e,Object.setPrototypeOf(this,I.prototype)}}class R extends Error{constructor(t){super(t),this.name="InvalidActionError",Object.setPrototypeOf(this,R.prototype)}}class O extends Error{constructor(t){super(t),this.name="InvalidArgumentsError",Object.setPrototypeOf(this,O.prototype)}}class B extends Error{constructor(t,e){super(t),this.name="SocketProtocolError",this.code=e,Object.setPrototypeOf(this,B.prototype)}}class P extends Error{constructor(t){super(t),this.name="TimeoutError",Object.setPrototypeOf(this,P.prototype)}}class N extends Error{constructor(t,e){super(t),this.name="BadConnectionError",this.type=e,Object.setPrototypeOf(this,N.prototype)}}const j={1001:"Socket was disconnected",1002:"A WebSocket protocol error was encountered",1003:"Server terminated socket because it received invalid data",1005:"Socket closed without status code",1006:"Socket hung up",1007:"Message format was incorrect",1008:"Encountered a policy violation",1009:"Message was too big to process",1010:"Client ended the connection because the server did not comply with extension requirements",1011:"Server encountered an unexpected fatal condition",4e3:"Server ping timed out",4001:"Client pong timed out",4002:"Server failed to sign auth token",4003:"Failed to complete handshake",4004:"Client failed to save auth token",4005:"Did not receive #handshake from client before timeout",4006:"Failed to bind socket to message broker",4007:"Client connection establishment timed out",4008:"Server rejected handshake from client",4009:"Server received a message before the client handshake"},$={1e3:"Socket closed normally",1001:"Socket hung up"};function q(t){let e;if(t&&"object"==typeof t){e={message:t.message};for(let s of Object.keys(t))e[s]=t[s]}else e="function"==typeof t?"[function "+("string"==typeof t.name?t.name:"anonymous")+"]":t;return s=[],n=[],function t(e,i){var r,o,a;if(!("object"!=typeof e||null===e||e instanceof Boolean||e instanceof Date||e instanceof Number||e instanceof RegExp||e instanceof String)){for(r=0;r<s.length;r+=1)if(s[r]===e)return{$ref:n[r]};if(s.push(e),n.push(i),"[object Array]"===Object.prototype.toString.apply(e))for(a=[],r=0;r<e.length;r+=1)a[r]=t(e[r],i+"["+r+"]");else for(o in a={},e)Object.prototype.hasOwnProperty.call(e,o)&&(a[o]=t(e[o],i+"["+JSON.stringify(o)+"]"));return a}return e}(e,"$");var s,n}function U(t){let e=null;if(null!=t)if("object"==typeof t){e=new Error("string"==typeof t.message?t.message:"Invalid error message format"),"string"==typeof t.name&&(e.name=t.name);for(let s of Object.keys(t))void 0===e[s]&&(e[s]=t[s])}else e=t;return e}class L{constructor(t){this.isRpc=t.isRpc,this.method=t.method,this.options=t.options,this.requestedAt=new Date,this.socket=t.socket,this.transport=t.transport,this.timeoutMs=t.timeoutMs}checkTimeout(t=0){if("number"==typeof this.timeoutMs&&this.getRemainingTimeMs()<=t)throw new P(`Method '${this.method}' timed out.`)}getRemainingTimeMs(){return"number"==typeof this.timeoutMs?this.requestedAt.valueOf()+this.timeoutMs-(new Date).valueOf():1/0}}function F(t){return"object"==typeof t&&"rid"in t}class z extends T{constructor(t,e){super(),this.state=e?.state||{},t.socket=this,this._transport=t}get id(){return this._transport.id}get authToken(){return this._transport.authToken}get signedAuthToken(){return this._transport.signedAuthToken}deauthenticate(){return this._transport.changeToUnauthenticatedState()}disconnect(t=1e3,e){this._transport.disconnect(t,e)}getBackpressure(){return Math.max(this._transport.getBackpressure(),this.getListenerBackpressure())}getInboundBackpressure(){return this._transport.getInboundBackpressure()}getOutboundBackpressure(){return this._transport.getOutboundBackpressure()}emit(t,e){super.emit(t,e)}listen(t){return super.listen(t)}get status(){return this._transport.status}get url(){return this._transport.url}transmit(t,e){return this._transport.transmit(t,e)}invoke(t,e){return this._transport.invoke(t,e)[0]}}const W="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",H=/^[ \n\r\t]*[{\[]/;function G(t){const e=new Uint8Array(t),s=e.length;let n="";for(let t=0;t<s;t+=3)n+=W[e[t]>>2],n+=W[(3&e[t])<<4|e[t+1]>>4],n+=W[(15&e[t+1])<<2|e[t+2]>>6],n+=W[63&e[t+2]];return s%3==2?n=n.substring(0,n.length-1)+"=":s%3==1&&(n=n.substring(0,n.length-2)+"=="),n}function J(t,e){if("undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer)return{base64:!0,data:G(e)};if("undefined"!=typeof Buffer){if(e instanceof Buffer)return{base64:!0,data:e.toString("base64")};if(e&&"Buffer"===e.type&&Array.isArray(e.data)){let t;return t=Buffer.from?Buffer.from(e.data):new Buffer(e.data),{base64:!0,data:t.toString("base64")}}}return e}const K=new class{decode(t){if(null==t)return null;if("#1"===t||"#2"===t)return t;const e=t.toString();if(!H.test(e))return e;try{return JSON.parse(e)}catch(t){}return e}encode(t){return"#1"===t||"#2"===t?t:JSON.stringify(t,J)}};var Q=null;"undefined"!=typeof WebSocket?Q=WebSocket:"undefined"!=typeof MozWebSocket?Q=MozWebSocket:"undefined"!=typeof global?Q=global.WebSocket||global.MozWebSocket:"undefined"!=typeof window?Q=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(Q=self.WebSocket||self.MozWebSocket);var V,X=Q;!function(t){t.AUTHENTICATED="authenticated",t.UNAUTHENTICATED="unauthenticated"}(V||(V={}));class Y{constructor(t){let e=1;this.ackTimeoutMs=t?.ackTimeoutMs??1e4,this._callIdGenerator=t?.callIdGenerator||(()=>e++),this._callbackMap={},this.codecEngine=t?.codecEngine||K,this._handlers=t?.handlers||{},this.id=null,this._inboundProcessedMessageCount=0,this._inboundReceivedMessageCount=0,this._outboundPreparedMessageCount=0,this._outboundSentMessageCount=0,this._pingTimeoutRef=null,this.plugins=t?.plugins||[],this.streamCleanupMode=t?.streamCleanupMode||"kill"}abortAllPendingCallbacksDueToBadConnection(t){for(const e in this._callbackMap){const s=this._callbackMap[e],n=`Event ${s.method} was aborted due to a bad connection`;s.callback(new N(n,"ready"===t?"disconnect":"connectAbort"))}}get authToken(){return this._authToken}async changeToUnauthenticatedState(){if(this._signedAuthToken){const t=this._authToken,e=this._signedAuthToken;this._authToken=null,this._signedAuthToken=null,this._socket.emit("authStateChange",{wasAuthenticated:!0,isAuthenticated:!1}),await M(0),this._socket.emit("deauthenticate",{signedAuthToken:e,authToken:t});for(const t of this.plugins)t.onDeauthenticate&&t.onDeauthenticate({socket:this.socket,transport:this});return!0}return!1}decode(t){try{return this.codecEngine.decode(t)}catch(t){return"Error"===t.name&&(t.name="InvalidMessageError"),this.onError(t),null}}disconnect(t=1e3,e){this.webSocket&&(this.webSocket.close(t,e),this.onClose(t,e))}getBackpressure(){return Math.max(this.getInboundBackpressure(),this.getOutboundBackpressure())}getInboundBackpressure(){return this._inboundReceivedMessageCount-this._inboundProcessedMessageCount}getOutboundBackpressure(){return this._outboundPreparedMessageCount-this._outboundSentMessageCount}async handleInboudMessage({packet:t,timestamp:e}){if(null!==t){var s;s=t,t=Array.isArray(s)?s:[s];for(let s of t){let t;try{for(const t of this.plugins)t.onMessage&&(s=await t.onMessage({socket:this.socket,transport:this,packet:s,timestamp:e}))}catch(e){t=e}F(s)?this.onResponse(s,t):E(s)&&await this.onRequest(s,e,t)}}}onClose(t,e){const s=this.status;this.webSocket=null,this._isReady=!1,clearTimeout(this._pingTimeoutRef),this._pingTimeoutRef=null,this.abortAllPendingCallbacksDueToBadConnection(s);for(const t of this.plugins)t.onClose&&t.onClose({socket:this.socket,transport:this});if(!$[t]){let s;s="string"==typeof e?`Socket connection closed with status code ${t} and reason: ${e}`:`Socket connection closed with status code ${t}`,this.onError(new B(j[t]||s,t))}const n=e?.toString()||j[t];this._socket.emit("close",{code:t,reason:n})}onDisconnect(t,e,s){"ready"===t?this._socket.emit("disconnect",{code:e,reason:s}):this._socket.emit("connectAbort",{code:e,reason:s});for(const n of this.plugins)n.onDisconnected&&n.onDisconnected({socket:this.socket,transport:this,status:t,code:e,reason:s})}onError(t){this._socket.emit("error",{error:t})}onInvoke(t){this.sendRequest([t])}onMessage(t,e){if(""===(t=e?t:t.toString()))return void this.onPingPong();const s=new Date;let n,i,r=Promise.resolve(t);const o=new Promise(((t,e)=>{n=t,i=e}));this._inboundReceivedMessageCount++;for(let t=0;t<this.plugins.length;t++){const e=this.plugins[t];e.onMessageRaw&&(r=r.then((t=>e.onMessageRaw({socket:this.socket,transport:this,message:t,timestamp:s,promise:o}))))}r.then((t=>{const n=this.decode(t);return this._socket.emit("message",{data:t,isBinary:e}),this.handleInboudMessage({packet:n,timestamp:s})})).then(n).catch((t=>{i(t),t instanceof I||this.onError(t)})).finally((()=>{this._inboundProcessedMessageCount++}))}onOpen(){for(const t of this.plugins)t.onOpen&&t.onOpen({socket:this.socket,transport:this})}onPingPong(){}async onRequest(t,e,s){this._socket.emit("request",{request:t});const n="number"==typeof t.ackTimeoutMs?new Date(e.valueOf()+t.ackTimeoutMs):null;let i,r,o=!1;if(s)o=!0,r=s,i={rid:t.cid,timeoutAt:n,error:s};else{const e=this._handlers[t.method];if(e){o=!0;try{const s=await e(new L({isRpc:!!t.cid,method:t.method.toString(),timeoutMs:t.ackTimeoutMs,socket:this._socket,transport:this,options:t.data}));t.cid&&(i={rid:t.cid,timeoutAt:n,data:s})}catch(e){r=e,t.cid&&(i={rid:t.cid,timeoutAt:n,error:r})}}}return i&&this.sendResponse([i]),r&&this.onError(r),o||(o=this.onUnhandledRequest(t)),o}onResponse(t,e){const s=this._callbackMap[t.rid];s&&(s.timeoutId&&(clearTimeout(s.timeoutId),delete s.timeoutId),e?s.callback(e):"error"in t?s.callback(U(t.error)):s.callback(null,"data"in t?t.data:void 0)),e?this._socket.emit("response",{response:{rid:t.rid,error:e}}):this._socket.emit("response",{response:t})}onSocketClose(t){this.onClose(t.code,t.reason)}onSocketError(t){this.onError(t.error)}onSocketMessage(t){this.onMessage(t.data,!1)}onTransmit(t){this.sendRequest([t])}onUnhandledRequest(t){return!!this._onUnhandledRequest&&this._onUnhandledRequest(this,t)}resetPingTimeout(t,e){this._pingTimeoutRef&&(clearTimeout(this._pingTimeoutRef),this._pingTimeoutRef=null),!1!==t&&(this._pingTimeoutRef=setTimeout((()=>{this.webSocket.close(e)}),t))}send(t){return new Promise(((e,s)=>{try{this._webSocket.send(t,(t=>{t?s(t):e()}))}catch(t){throw t}}))}sendRequest(t,e){if("object"==typeof t&&(e=t,t=0),e.some((t=>A(t)))&&!(e=e.filter((t=>A(t)))).length)return;for(;t<this.plugins.length;t++){const s=this.plugins[t];if("sendRequest"in s){t++;try{s.sendRequest({socket:this.socket,transport:this,requests:e,cont:this.sendRequest.bind(this,t)})}catch(t){for(const s of e)x(s,t)}return}}if("closed"===this.status){for(const t of e){const e=new N(`Socket ${"callback"in t?"invoke":"transmit"} ${String(t.method)} event was aborted due to a bad connection`,"connectAbort");this.onError(e),x(t,e)}return}const s=e.map((t=>{if("callback"in t){const{callback:e,promise:s,timeoutId:n,...i}=t;return this._callbackMap[t.cid]={method:["service"in t?t.service:"",t.method].filter(Boolean).join("."),timeoutId:t.timeoutId,callback:t.callback},i}const{promise:e,...s}=t;return s}));let n;this.send(this.codecEngine.encode(1===s.length?s[0]:s)).catch((t=>{n=t})).then((()=>{const t=n?.code;for(const s of e)"ECONNRESET"===t&&(n=new N(`Socket ${"callback"in s?"invoke":"transmit"} ${String(s.method)} event was aborted due to a bad connection`,"connectAbort")),s.sentCallback&&s.sentCallback(n),n&&"callback"in s&&s.callback(n)})).catch((t=>{this.onError(t)}))}sendResponse(t,e){if("object"==typeof t&&(e=t,t=0),(e=e.filter((t=>!t.timeoutAt||t.timeoutAt>new Date))).length){for(;t<this.plugins.length;t++){const s=this.plugins[t];if("sendResponse"in s){t++;try{s.sendResponse({socket:this.socket,transport:this,responses:e,cont:this.sendResponse.bind(this,t)})}catch(s){this.sendResponse(t,e.map((t=>({rid:t.rid,timeoutAt:t.timeoutAt,error:s}))))}return}}if("closed"!==this.status){for(const t of e)"error"in t&&(t.error=q(t.error)),delete t.timeoutAt;this.send(this.codecEngine.encode(1===e.length?e[0]:e)).catch((t=>{this.onError(t)}))}else for(const t of e)this.onError(new Error("WebSocket is not open: readyState 3 (CLOSED)"))}}async setAuthorization(t,e){if("string"!=typeof t)throw new O("SignedAuthToken must be type string.");if(t!==this._signedAuthToken){if(!e){const s=function(t){if("string"!=typeof t)return null;let e=t.split(".")[1];if(null!=e){let t=e;try{return t=Buffer.from(t,"base64").toString("utf8"),JSON.parse(t)}catch(e){return t}}return null}(t);if("string"==typeof s)throw new O("Invalid authToken.");e=s}return this._authToken=e,this._signedAuthToken=t,!0}return!1}setReadyStatus(t,e){if(this._webSocket?.readyState!==X.OPEN)throw new R("Cannot set status to OPEN before socket is connected.");this._isReady=!0;for(const t of this.plugins)t.onReady&&t.onReady({socket:this.socket,transport:this});this._socket.emit("connect",{id:this.id,pingTimeoutMs:t,isAuthenticated:!!this.signedAuthToken,authError:e})}get signedAuthToken(){return this._signedAuthToken}get socket(){return this._socket}set socket(t){this._socket=t}get status(){if(!this._webSocket)return"closed";if(this._isReady)return"ready";switch(this._webSocket.readyState){case X.CONNECTING:case X.OPEN:return"connecting";case X.CLOSING:return"closing";default:return"closed"}}triggerAuthenticationEvents(t,e){this._socket.emit("authStateChange",{wasAuthenticated:e,isAuthenticated:!0,authToken:this._authToken,signedAuthToken:this._signedAuthToken}),this._socket.emit("authenticate",{wasSigned:t,signedAuthToken:this._signedAuthToken,authToken:this._authToken});for(const t of this.plugins)t.onAuthenticated&&t.onAuthenticated({socket:this.socket,transport:this})}transmit(t,e){let s,n,i;Array.isArray(t)?(s=t[0],n=t[1]):i=t;const r=s?{service:s,method:n,promise:null,data:e}:{data:e,method:i,promise:null},o=r.promise=new Promise(((t,e)=>{r.sentCallback=s=>{delete r.sentCallback,this._outboundSentMessageCount++,s?e(s):t()}}));return this._outboundPreparedMessageCount++,this.onTransmit(r),o}invoke(t,e){let s,n,i,r;"object"==typeof t?Array.isArray(t)?(s=t[0],n=t[1],r=t[2]):("service"in t?(s=t.service,n=t.method):i=t.method,r=t.ackTimeoutMs):i=t;let o=this._callbackMap;const a=Object.assign({cid:this._callIdGenerator(),ackTimeoutMs:r??this.ackTimeoutMs,callback:null,promise:null},s?{service:s,method:n,data:e}:{method:i,data:e});let h;const c=a.promise=new Promise(((t,e)=>{a.ackTimeoutMs&&(a.timeoutId=setTimeout((()=>{delete o[a.cid],a.callback=null,clearTimeout(a.timeoutId),delete a.timeoutId,e(new P(`Method '${[s,a.method].filter(Boolean).join(".")}' timed out.`))}),a.ackTimeoutMs)),h=()=>{delete o[a.cid],a.timeoutId&&(clearTimeout(a.timeoutId),delete a.timeoutId),a.callback&&(a.callback=null,e(new D(`Method '${[s,a.method].filter(Boolean).join(".")}' was aborted.`)))},a.callback=(s,n)=>{delete o[a.cid],a.callback=null,a.timeoutId&&(clearTimeout(a.timeoutId),delete a.timeoutId),s?e(s):t(n)},a.sentCallback=()=>{delete a.sentCallback,this._outboundSentMessageCount++}}));return this._outboundPreparedMessageCount++,this.onInvoke(a),[c,h]}get url(){return this._webSocket.url}get webSocket(){return this._webSocket}set webSocket(t){this._webSocket&&(this._webSocket.onclose=null,this._webSocket.onerror=null,this._webSocket.onmessage=null,this._webSocket.onopen=null,delete this.onSocketClose,delete this.onSocketError,delete this.onSocketMessage,delete this.onOpen),this._webSocket=t,t&&(this._webSocket.onclose=this.onSocketClose=this.onSocketClose.bind(this),this._webSocket.onopen=this.onOpen=this.onOpen.bind(this),this._webSocket.onerror=this.onSocketError=this.onSocketError.bind(this),this._webSocket.onmessage=this.onSocketMessage=this.onSocketMessage.bind(this))}}class Z extends Y{constructor(t){super(t),this.type="client",this._uri="string"==typeof t.address?new URL(t.address):t.address,this.authEngine=p(t.authEngine)?t.authEngine:new g(Object.assign({authTokenName:`socketmesh.authToken${this._uri.protocol}${this._uri.hostname}`},t.authEngine)),this.connectTimeoutMs=t.connectTimeoutMs??2e4,this._pingTimeoutMs=this.connectTimeoutMs,t.wsOptions&&(this._wsOptions=t.wsOptions),this._connectAttempts=0,this._pendingReconnectTimeout=null,this.autoReconnect=t.autoReconnect,this.isPingTimeoutDisabled=!0===t.isPingTimeoutDisabled}get autoReconnect(){return this._autoReconnect}set autoReconnect(t){this._autoReconnect=!!t&&Object.assign({initialDelay:1e4,randomness:1e4,multiplier:1.5,maxDelayMs:6e4},!0===t?{}:t)}connect(t){let e=this.connectTimeoutMs;if(t){let s=!1;t.connectTimeoutMs&&(e=t.connectTimeoutMs),t.address&&(s=!0,this._uri="string"==typeof t.address?new URL(t.address):t.address),t.wsOptions&&(s=!0,this._wsOptions=t.wsOptions),s&&"closed"!==this.status&&this.disconnect(1e3,"Socket was disconnected by the client to initiate a new connection")}"closed"===this.status&&(this.webSocket=new X(this._uri,this._wsOptions),this.socket.emit("connecting",{}),this._connectTimeoutRef=setTimeout((()=>{this.disconnect(4007)}),e))}get connectAttempts(){return this._connectAttempts}disconnect(t=1e3,e){4007!==t&&this.resetReconnect(),super.disconnect(t,e)}async handshake(){const t=await this.authEngine.loadToken(),e=await this.invoke("#handshake",{authToken:t})[0];return"authError"in e&&(e.authError=U(e.authError)),e}onClose(t,e){const s=this.status;let n=!1;if(super.onClose(t,e),this.autoReconnect&&(4e3===t||4001===t||1005===t?(n=!!this.autoReconnect,this.tryReconnect(0)):1e3!==t&&t<4500&&(n=!!this.autoReconnect,this.tryReconnect())),!n){const n=e?.toString()||j[t];this.onDisconnect(s,t,n)}}onOpen(){let t;super.onOpen(),clearTimeout(this._connectTimeoutRef),this._connectTimeoutRef=null,this.resetReconnect(),this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3),this.handshake().then((e=>(this.id=e.id,this.pingTimeoutMs=e.pingTimeoutMs,"authToken"in e&&e.authToken?this.setAuthorization(e.authToken):("authError"in e&&(t=e.authError),this.changeToUnauthenticatedState())))).then((()=>{this.setReadyStatus(this.pingTimeoutMs,t)})).catch((t=>{null==t.statusCode&&(t.statusCode=4003),this.onError(t),this.disconnect(t.statusCode,t.toString())}))}onPingPong(){this.send(""),this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3),this.socket.emit("ping",{})}get pendingReconnect(){return null!==this._pendingReconnectTimeout}get pingTimeoutMs(){return this._pingTimeoutMs}set pingTimeoutMs(t){this._pingTimeoutMs=t,this.resetPingTimeout(!this.isPingTimeoutDisabled&&this.pingTimeoutMs,4e3)}resetReconnect(){this._pendingReconnectTimeout=null,this._connectAttempts=0}async send(t){this.webSocket.send(t)}async setAuthorization(t,e){const s=!!this.signedAuthToken,n=await super.setAuthorization(t,e);return n&&(this.triggerAuthenticationEvents(!1,s),this.authEngine.saveToken(this.signedAuthToken).catch((t=>{this.onError(t)}))),n}get status(){return this.pendingReconnect?"connecting":super.status}tryReconnect(t){if(!this.autoReconnect)return;const e=this._connectAttempts++,s=this.autoReconnect;let n;if(null==t||e>0){const t=Math.round(s.initialDelay+(s.randomness||0)*Math.random());n=Math.round(t*Math.pow(s.multiplier,e))}else n=t;n>s.maxDelayMs&&(n=s.maxDelayMs),this._pendingReconnectTimeout=n,this.connect({connectTimeoutMs:n})}get uri(){return this._uri}get webSocket(){return super.webSocket}set webSocket(t){if(this.webSocket&&this._connectTimeoutRef&&(clearTimeout(this._connectTimeoutRef),this._connectTimeoutRef=null),super.webSocket=t,this.webSocket&&this.webSocket.on){function e(){this.off("open",e),this.off("close",e),this.off("error",e)}this.webSocket.on("open",e),this.webSocket.on("close",e),this.webSocket.on("error",e)}}async transmit(t,e){"closed"===this.status&&(this.connect(),await this.socket.listen("connect").once()),await super.transmit(t,e)}invoke(t,e){let s;return[Promise.resolve().then((()=>{if("closed"===this.status)return this.connect(),this.socket.listen("connect").once()})).then((()=>{const n=super.invoke(t,e);return s=n[1],n[0]})),s]}}function tt(t){return("string"==typeof t||"pathname"in t)&&(t={address:t}),Object.assign({},t)}class et extends z{constructor(i){(i=tt(i)).handlers=Object.assign({"#kickOut":t,"#publish":e,"#setAuthToken":n,"#removeAuthToken":s},i.handlers);const r=new Z(i);super(r,i),this._clientTransport=r,this.channels=new w(this._clientTransport,i),!1!==i.autoConnect&&this.connect(i)}async authenticate(t){try{await this._clientTransport.invoke("#authenticate",t)[0],this._clientTransport.setAuthorization(t),await M(0)}catch(t){throw"BadConnectionError"!==t.name&&"TimeoutError"!==t.name&&(await this._clientTransport.changeToUnauthenticatedState(),await M(0)),U(t)}}get autoReconnect(){return this._clientTransport.autoReconnect}set autoReconnect(t){this._clientTransport.autoReconnect=t}connect(t){this._clientTransport.connect(t)}get connectTimeoutMs(){return this._clientTransport.connectTimeoutMs}set connectTimeoutMs(t){this._clientTransport.connectTimeoutMs=t}async deauthenticate(){return(async()=>{let t;try{t=await this._clientTransport.authEngine.removeToken()}catch(t){return void this._clientTransport.onError(t)}this.emit("removeAuthToken",{oldAuthToken:t})})(),"closed"!==this.status&&await this._clientTransport.transmit("#removeAuthToken"),await super.deauthenticate()}get isPingTimeoutDisabled(){return this._clientTransport.isPingTimeoutDisabled}set isPingTimeoutDisabled(t){this._clientTransport.isPingTimeoutDisabled=t}get pingTimeoutMs(){return this._clientTransport.pingTimeoutMs}set pingTimeoutMs(t){this._clientTransport.pingTimeoutMs=t}reconnect(t,e){this.disconnect(t,e),this.connect()}get type(){return this._clientTransport.type}get uri(){return this._clientTransport.uri}}export{i as BatchingPlugin,w as ClientChannels,et as ClientSocket,Z as ClientTransport,l as InOrderPlugin,g as LocalStorageAuthEngine,d as OfflinePlugin,r as RequestBatchingPlugin,o as ResponseBatchingPlugin,p as isAuthEngine,t as kickOutHandler,tt as parseClientOptions,e as publishHandler,s as removeAuthTokenHandler,n as setAuthTokenHandler};
